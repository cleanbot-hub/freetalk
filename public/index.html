<!doctype html> 
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Freetalk</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f7f8fb;--ink:#0f1724;--muted:#6b7280;--accent:#6d28d9;--accent2:#7c3aed;--danger:#ef4444;--bd:#e5e7eb;--radius:12px;--max:1120px}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Malgun Gothic,sans-serif}

    /* 공통 */
    .wrap{max-width:var(--max);margin:18px auto;padding:12px}
    header.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .brand{display:flex;gap:10px;align-items:center;text-decoration:none;color:inherit}
    .nav{display:flex;gap:8px;align-items:center}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--bd);background:#fff;color:#111;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border:0}
    .btn.danger{background:var(--danger);color:#fff;border:0}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--bd);background:#f8fafc;font-size:12px;color:#374151}
    .card{background:#fff;border:1px solid var(--bd);border-radius:12px;box-shadow:0 8px 26px rgba(2,6,23,.06);padding:14px}
    .muted{color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:10px}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:flex-start;border:1px solid #eef;border-radius:10px;padding:12px}
    .row-compact{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .field{padding:10px;border:1px solid var(--bd);border-radius:10px;background:#fff;width:100%}
    .empty{color:var(--muted);text-align:center;padding:18px;background:#fafbff;border-radius:10px;border:1px dashed #e5e7eb}
    .tabs{display:flex;gap:8px;margin:8px 0 12px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:10px;border:1px solid var(--bd);background:#fff;cursor:pointer}
    .tab.active{background:var(--accent);color:#fff;border-color:transparent}
    .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    @media(min-width:900px){ .grid2{grid-template-columns:1fr 1fr} .grid3{grid-template-columns:1fr 1fr 1fr} }
    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:12px}
    .kpi .tile{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px}
    .kpi .num{font-size:22px;font-weight:700}

    /* ===== 이송 보드 ===== */
    .board{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:1000px){ .board{grid-template-columns:1fr 1fr 1fr 1fr} }
    .col{border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff;min-height:160px}
    .col h4{margin:0 0 8px;font-size:15px}
    .slot{border:2px dashed #e5e7eb;border-radius:10px;padding:18px;text-align:center;color:#94a3b8}
    .card-tp{border:1px solid #eef;border-radius:12px;padding:10px;background:#fff;display:flex;flex-direction:column;gap:6px}
    .tp-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .tp-line{font-size:13px;color:#374151}
    .tp-meta{display:flex;gap:6px;flex-wrap:wrap}
    .chip{border:1px solid #e5e7eb;background:#fafafa;border-radius:999px;padding:2px 8px;font-size:12px}
    .chip.stat{background:#fff1f2;border-color:#fecaca;color:#b91c1c}
    .chip.bed{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8}
    .chip.wheel{background:#f0fdf4;border-color:#bbf7d0;color:#166534}
    .chip.iso{background:#fefce8;border-color:#fde68a;color:#92400e}
    .tp-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}

    /* ===== 모달 공통 ===== */
    .backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:1200}
    .modal{width:min(760px,96vw);background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 18px 50px rgba(2,6,23,.35);padding:16px}

    /* Porter picker modal */
    .porter-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .porter-search{display:flex;gap:8px;margin-bottom:10px}
    .porter-field{flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
    .porter-list{max-height:55vh;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .porter-item{display:flex;justify-content:space-between;align-items:center;border:1px solid #eef;border-radius:10px;padding:10px;background:#fff}
    .porter-meta{display:flex;gap:8px;align-items:center}
    .porter-dot{width:10px;height:10px;border-radius:50%;border:1px solid #16a34a}
    .porter-dot.on{background:#22c55e}
    .porter-dot.off{background:#cbd5e1;border-color:#94a3b8}
  </style>
</head>
<body>

<!-- ▷ 일반 사용자 홈 -->
<div id="public-home" class="wrap" style="display:none">
  <header class="top">
    <a class="brand" href="/index.html"><strong>Freetalk</strong></a>
    <nav class="nav">
      <a class="btn" href="/community.html">커뮤니티</a>
      <a class="btn" href="/chat.html">채팅</a>
      <button id="logout1" class="btn">로그아웃</button>
    </nav>
  </header>

  <section class="card">
    <h2 style="margin:0 0 8px">자유롭게 소통하는 온라인 커뮤니티</h2>
    <p class="muted" style="margin:0 0 12px">로그인한 사용자는 글/댓글/채팅이 가능합니다.</p>
    <div class="row-compact">
      <a class="btn primary" href="/chat.html">바로 채팅하기</a>
      <a class="btn" href="/community.html">커뮤니티 둘러보기</a>
      <span id="admin-shortcut" class="badge" style="display:none">관리자 계정입니다 · 상단 “관리자” 메뉴로 이동</span>
    </div>
  </section>
</div>

<!-- ▷ 관리자 대시보드 -->
<div id="admin-app" class="wrap" style="display:none">
  <header class="top">
    <a class="brand" href="/index.html"><strong>Freetalk</strong> <span class="badge">관리자 대시보드</span></a>
    <nav class="nav">
      <a class="btn" href="/community.html">커뮤니티</a>
      <a class="btn" href="/chat.html">채팅</a>
      <button id="logout2" class="btn">로그아웃</button>
    </nav>
  </header>

  <div class="tabs">
    <button id="tab-home" class="tab active">요약</button>
    <button id="tab-transport" class="tab">이송</button>
    <button id="tab-posts" class="tab">게시글</button>
    <button id="tab-chat"  class="tab">채팅</button>
    <button id="tab-comments" class="tab">댓글/답글</button>
    <button id="tab-users" class="tab">사용자/밴</button>
    <button id="tab-admin" class="tab">관리자</button>
  </div>

  <!-- ===== 요약 ===== -->
  <section id="panel-home" class="card">
    <div class="kpi">
      <div class="tile"><div class="muted">게시글</div><div id="kpi-posts" class="num">-</div></div>
      <div class="tile"><div class="muted">댓글</div><div id="kpi-comments" class="num">-</div></div>
      <div class="tile"><div class="muted">채팅</div><div id="kpi-chats" class="num">-</div></div>
      <div class="tile"><div class="muted">사용자</div><div id="kpi-users" class="num">-</div></div>
    </div>
    <div class="grid2">
      <div>
        <div class="muted" style="margin-bottom:6px">최근 게시글</div>
        <div id="home-posts" class="list"><div class="empty">불러오는 중…</div></div>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">최근 채팅</div>
        <div id="home-chats" class="list"><div class="empty">불러오는 중…</div></div>
      </div>
    </div>
  </section>

  <!-- ===== 이송(Transport) ===== -->
  <section id="panel-transport" class="card" style="display:none">
    <div class="row-compact" style="justify-content:space-between;margin-bottom:10px">
      <div class="row-compact">
        <strong>이송 관리</strong>
        <span id="tp-total" class="badge">0건</span>
      </div>
      <div class="row-compact">
        <button id="btn-tp-new" class="btn primary">이송 요청 만들기</button>
        <button id="btn-tp-refresh" class="btn">새로고침</button>
      </div>
    </div>

    <div class="kpi">
      <div class="tile"><div class="muted">대기</div><div id="kpi-q" class="num">0</div></div>
      <div class="tile"><div class="muted">배정됨</div><div id="kpi-a" class="num">0</div></div>
      <div class="tile"><div class="muted">진행중</div><div id="kpi-p" class="num">0</div></div>
      <div class="tile"><div class="muted">완료(오늘)</div><div id="kpi-d" class="num">0</div></div>
    </div>

    <div class="board">
      <div class="col">
        <h4>대기</h4>
        <div id="col-queued" class="list"><div class="slot">대기 없음</div></div>
      </div>
      <div class="col">
        <h4>배정됨</h4>
        <div id="col-assigned" class="list"><div class="slot">배정 없음</div></div>
      </div>
      <div class="col">
        <h4>진행중</h4>
        <div id="col-progress" class="list"><div class="slot">진행중 없음</div></div>
      </div>
      <div class="col">
        <h4>완료(오늘)</h4>
        <div id="col-done" class="list"><div class="slot">완료 없음</div></div>
      </div>
    </div>
  </section>

  <!-- ===== 게시글 ===== -->
  <section id="panel-posts" class="card" style="display:none">
    <div class="row-compact">
      <div class="row-compact">
        <strong>게시글</strong>
        <span id="post-count" class="badge">0</span>
        <span class="muted">(페이지당 10개)</span>
      </div>
      <div class="row-compact" style="margin-left:auto">
        <button id="post-del-page" class="btn danger">이 페이지 모두 삭제</button>
        <button id="post-del-all"  class="btn danger">전체 게시글 삭제(위험)</button>
        <div class="pager">
          <button id="post-prev" class="btn">이전</button>
          <span class="badge" id="post-page">1 / 1</span>
          <button id="post-next" class="btn">다음</button>
        </div>
      </div>
    </div>
    <div id="post-list" class="list"><div class="empty">불러오는 중…</div></div>
  </section>

  <!-- ===== 채팅 ===== -->
  <section id="panel-chat" class="card" style="display:none">
    <div class="row-compact" style="justify-content:space-between">
      <div class="row-compact">
        <strong>채팅 메시지</strong>
        <span class="muted">개별 삭제 또는 전체 삭제</span>
      </div>
      <div class="row-compact">
        <button id="chat-del-all" class="btn danger">전체 채팅 삭제(위험)</button>
        <div class="pager">
          <button id="chat-prev" class="btn">이전</button>
          <span class="badge" id="chat-page">1</span>
          <button id="chat-next" class="btn">다음</button>
        </div>
      </div>
    </div>
    <div id="chat-list" class="list"><div class="empty">불러오는 중…</div></div>
  </section>

  <!-- ===== 댓글/답글 ===== -->
  <section id="panel-comments" class="card" style="display:none">
    <div class="row-compact" style="justify-content:space-between">
      <div class="row-compact">
        <strong>댓글/답글 관리</strong>
        <span class="muted">게시글 ID를 입력해 댓글/답글을 조회·삭제</span>
      </div>
      <div class="grid3" style="align-items:center">
        <input id="cm-postid" class="field" placeholder="communityPosts/{postId}">
        <button id="cm-load" class="btn">불러오기</button>
        <button id="cm-del-all" class="btn danger">이 글의 댓글/답글 전체 삭제</button>
      </div>
    </div>
    <div id="cm-list" class="list"><div class="empty">게시글 ID를 입력한 뒤 불러오기를 누르세요.</div></div>
  </section>

  <!-- ===== 사용자/밴 ===== -->
  <section id="panel-users" class="card" style="display:none">
    <div class="row-compact" style="justify-content:space-between">
      <div><strong>사용자 검색/밴</strong></div>
      <div class="muted">별명 또는 UID로 조회 → 밴(정지)/해제</div>
    </div>
    <div class="grid2" style="margin-bottom:8px">
      <div class="row-compact">
        <input id="u-nick" class="field" placeholder="별명으로 검색">
        <button id="u-find-nick" class="btn">검색</button>
      </div>
      <div class="row-compact">
        <input id="u-uid" class="field" placeholder="UID로 검색">
        <button id="u-find-uid" class="btn">검색</button>
      </div>
    </div>
    <div class="grid2" style="margin-bottom:10px">
      <input id="ban-reason" class="field" placeholder="정지 사유(선택)">
      <div class="row-compact">
        <input id="ban-days" class="field" type="number" min="0" placeholder="정지 일수(0=영구)">
        <button id="u-ban" class="btn danger">정지</button>
        <button id="u-unban" class="btn">정지 해제</button>
      </div>
    </div>
    <div id="u-info" class="list"><div class="empty">검색 결과가 여기에 표시됩니다.</div></div>
    <div class="badge" style="margin-top:10px">
      ⚠️ 보안규칙에서 <code>bans/{uid}.banned</code>와 <code>until</code> 검사로 create 차단 필요
    </div>
  </section>

  <!-- ===== 관리자 ===== -->
  <section id="panel-admin" class="card" style="display:none">
    <div class="row-compact" style="justify-content:space-between">
      <div><strong>관리자 설정</strong></div>
      <span class="muted">별명 또는 UID로 추가 · 목록에서 삭제</span>
    </div>
    <div class="grid2" style="margin-bottom:10px">
      <div class="row-compact">
        <input id="adm-nick" class="field" placeholder="별명 입력(예: 개발자)">
        <button id="adm-add-nick" class="btn primary">별명으로 추가</button>
      </div>
      <div class="row-compact">
        <input id="adm-uid" class="field" placeholder="UID 직접 입력">
        <button id="adm-add-uid" class="btn">UID로 추가</button>
      </div>
    </div>
    <div class="muted" style="margin:-6px 0 12px">※ 별명 추가는 <code>nicknames/{별명소문자}</code>에서 UID를 찾아 등록합니다.</div>
    <div id="admin-list" class="list"><div class="empty">관리자 목록 불러오는 중…</div></div>
  </section>
</div>

<!-- ===== 이송 요청 만들기 모달 ===== -->
<div id="tpModal" class="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 style="margin:0 0 8px">이송 요청 만들기</h3>
    <div class="grid2">
      <input id="tp-pid" class="field" placeholder="환자 ID/MRN">
      <input id="tp-pname" class="field" placeholder="환자 성명">
      <input id="tp-from" class="field" placeholder="출발지 (예: 71병동-7103)">
      <input id="tp-to" class="field" placeholder="도착지 (예: CT실)">
      <select id="tp-pri" class="field">
        <option value="Routine">보통</option>
        <option value="STAT">긴급</option>
      </select>
      <select id="tp-type" class="field">
        <option value="bed">침대</option>
        <option value="wheelchair">휠체어</option>
        <option value="isolation">격리</option>
      </select>
      <input id="tp-sched" type="datetime-local" class="field">
      <input id="tp-notes" class="field" placeholder="특이사항(선택)">
    </div>
    <div class="row-compact" style="justify-content:flex-end;margin-top:10px">
      <button id="tp-cancel" class="btn">취소</button>
      <button id="tp-save" class="btn primary">저장</button>
    </div>
  </div>
</div>

<!-- ===== 포터 선택 모달 ===== -->
<div id="porterPicker" class="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="porterTitle">
    <div class="porter-head">
      <strong id="porterTitle">포터 선택</strong>
      <button id="porterCancel" class="btn">닫기</button>
    </div>
    <div class="porter-search">
      <input id="porterQuery" class="porter-field" placeholder="이름(별명) 또는 UID 검색">
    </div>
    <div id="porterList" class="porter-list"><div class="empty">목록 불러오는 중…</div></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import {
  getFirestore, collection, query, orderBy, limit, startAfter, getDocs, doc, deleteDoc, getDoc, setDoc,
  getCountFromServer, serverTimestamp, writeBatch, addDoc, updateDoc, where
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getDatabase, ref, onValue, serverTimestamp as rtdbNow } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

/* ===== Firebase ===== */
const cfg = {
  apiKey:"AIzaSyACn_-2BLztKYmBKXtrKNtMsC-2Y238oug",
  authDomain:"woori-1ecf5.firebaseapp.com",
  projectId:"woori-1ecf5",
  storageBucket:"woori-1ecf5.firebasestorage.app",
  messagingSenderId:"1073097361525",
  appId:"1:1073097361525:web:3218ced6a040aaaf4d503c",
  databaseURL:"https://woori-1ecf5-default-rtdb.firebaseio.com"
};
const app = initializeApp(cfg);
const auth = getAuth(app);
const db   = getFirestore(app);
const rtdb = getDatabase(app);

/* ===== DOM shortcuts ===== */
const $ = (id)=>document.getElementById(id);

/* ===== 화면 토글 ===== */
const adminApp   = $('admin-app');
const publicHome = $('public-home');
const logout1 = $('logout1');
const logout2 = $('logout2');

function showPublic(isAdmin=false){
  adminApp.style.display = 'none';
  publicHome.style.display = 'block';
  const tip = document.getElementById('admin-shortcut');
  if(tip) tip.style.display = isAdmin ? 'inline-block' : 'none';
}
function showAdmin(){
  publicHome.style.display = 'none';
  adminApp.style.display   = 'block';
}

/* ===== 유틸 ===== */
const esc = s=>String(s||'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
const fmt = ts=>{
  try{
    if(ts?.toDate) return ts.toDate().toLocaleString();
    if(typeof ts==='string') return new Date(ts).toLocaleString();
    return '';
  }catch{ return ''; }
};
const err = (e)=>{ console.error(e); alert('오류: '+(e?.message||e?.code||'unknown')); };

/* ===== 인증 & 부팅 ===== */
onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.replace('/login.html'); return; }
  try{
    const a = await getDoc(doc(db,'admins', u.uid));
    if(!a.exists()){
      showPublic(false);
      return;
    }
    showAdmin();
    await Promise.all([loadHome(), loadPostPage(1), loadChatPage(1), loadAdmins(), loadTransportBoard()]);
  }catch(e){
    console.error(e);
    showPublic(false);
  }
});
const doLogout = ()=>signOut(auth);
if(logout1) logout1.onclick = doLogout;
if(logout2) logout2.onclick = doLogout;

/* ===== 홈(요약) ===== */
async function countCol(pathArr){
  const refc = collection(db, ...pathArr);
  const snap = await getCountFromServer(refc);
  return snap.data().count || 0;
}
async function loadHome(){
  $('kpi-posts').textContent   = await countCol(['communityPosts']);
  $('kpi-comments').textContent= await countCol(['communityPosts']);
  $('kpi-chats').textContent   = await countCol(['rooms','global','messages']);
  $('kpi-users').textContent   = await countCol(['users']);

  const pSnap = await getDocs(query(collection(db,'communityPosts'), orderBy('createdAt','desc'), limit(5)));
  const homePosts = $('home-posts'); homePosts.innerHTML='';
  if(pSnap.empty){ homePosts.innerHTML='<div class="empty">최근 게시글 없음</div>'; }
  else pSnap.forEach(d=>{
    const x=d.data();
    const el=document.createElement('div'); el.className='row';
    el.innerHTML=`<div>
      <div class="muted">${fmt(x.createdAt)} · <span class="badge">${esc(x.authorName||'익명')}</span></div>
      <div><b>${esc(x.title||'(제목 없음)')}</b></div>
      <div class="muted" style="margin-top:4px">${esc((x.body||'').slice(0,140))}</div>
    </div>`;
    homePosts.appendChild(el);
  });

  const cSnap = await getDocs(query(collection(db,'rooms','global','messages'), orderBy('createdAt','desc'), limit(5)));
  const homeChats = $('home-chats'); homeChats.innerHTML='';
  if(cSnap.empty){ homeChats.innerHTML='<div class="empty">최근 채팅 없음</div>'; }
  else cSnap.forEach(d=>{
    const x=d.data();
    const el=document.createElement('div'); el.className='row';
    el.innerHTML=`<div>
      <div class="muted">${fmt(x.createdAt)} · <span class="badge">${esc(x.senderName||'익명')}</span></div>
      <div>${esc(x.text||'')}</div>
    </div>`;
    homeChats.appendChild(el);
  });
}

/* ===== 게시글 ===== */
const POST_PAGE_SIZE=10;
let postPage=1, postTotalPages=1;
let postCursors=[null];
const postList=$('post-list'), postCnt=$('post-count'), postPageLbl=$('post-page');
$('post-prev').onclick=()=>{ if(postPage>1) loadPostPage(postPage-1); };
$('post-next').onclick=()=>{ if(postPage<postTotalPages) loadPostPage(postPage+1); };
$('post-del-page').onclick=async()=>{
  const ids=[...postList.querySelectorAll('[data-id]')].map(el=>el.getAttribute('data-id'));
  if(!ids.length) return;
  if(!confirm('현재 페이지의 게시글을 모두 삭제할까요? (댓글/답글/좋아요 포함)')) return;
  for(const id of ids){ await deletePostDeep(id).catch(console.error); }
  await loadPostPage(postPage);
};
$('post-del-all').onclick=async()=>{
  if(!confirm('정말 전체 게시글을 삭제할까요? 되돌릴 수 없습니다.')) return;
  await deleteCollectionDeep(['communityPosts'], 50, async (postId)=>{ await deletePostDeep(postId); });
  await loadPostPage(1);
};
async function loadPostPage(page){
  postList.innerHTML='<div class="empty">불러오는 중…</div>';
  const agg = await getCountFromServer(collection(db,'communityPosts'));
  const total = agg.data().count||0; postCnt.textContent = total;
  postTotalPages = Math.max(1, Math.ceil(total/POST_PAGE_SIZE));

  let qref = query(collection(db,'communityPosts'), orderBy('createdAt','desc'), limit(POST_PAGE_SIZE));
  const cursor = postCursors[page-1]; if(cursor) qref = query(qref, startAfter(cursor));
  const snap = await getDocs(qref);
  const docs = snap.docs; if(docs.length) postCursors[page] = docs[docs.length-1];

  postList.innerHTML='';
  if(!docs.length){ postList.innerHTML='<div class="empty">표시할 게시글이 없습니다.</div>'; }
  else docs.forEach(d=>{
    const x=d.data();
    const el=document.createElement('div'); el.className='row'; el.setAttribute('data-id', d.id);
    el.innerHTML=`<div>
      <div class="muted">${fmt(x.createdAt)} · <span class="badge">${esc(x.authorName||'익명')}</span></div>
      <div><b>${esc(x.title||'(제목 없음)')}</b></div>
      <div class="muted" style="margin-top:4px">${esc((x.body||'').slice(0,200))}</div>
    </div>
    <div class="row-compact">
      <button class="btn" data-open-comments="${d.id}">댓글 보기</button>
      <button class="btn danger" data-del="${d.id}">삭제</button>
    </div>`;
    el.querySelector(`[data-open-comments="${d.id}"]`).onclick=()=>{
      document.getElementById('tab-comments').click();
      document.getElementById('cm-postid').value=d.id; document.getElementById('cm-load').click();
    };
    el.querySelector(`[data-del="${d.id}"]`).onclick=async()=>{
      if(!confirm('이 게시글과 하위 댓글/답글/좋아요를 모두 삭제할까요?')) return;
      await deletePostDeep(d.id).catch(console.error); el.remove();
    };
    postList.appendChild(el);
  });

  postPage=page; postPageLbl.textContent=`${postPage} / ${postTotalPages}`;
}

/* ===== 채팅 ===== */
const CHAT_PAGE_SIZE=30;
let chatPage=1; let chatCursors=[null];
const chatList=$('chat-list'), chatPageLbl=$('chat-page');
$('chat-prev').onclick=()=>{ if(chatPage>1) loadChatPage(chatPage-1); };
$('chat-next').onclick=()=>{ loadChatPage(chatPage+1); };
$('chat-del-all').onclick=async()=>{
  if(!confirm('정말 전체 채팅 메시지를 삭제할까요?')) return;
  await deleteCollectionDeep(['rooms','global','messages'], 100);
  await loadChatPage(1);
};
async function loadChatPage(page){
  chatList.innerHTML='<div class="empty">불러오는 중…</div>';
  let qref = query(collection(db,'rooms','global','messages'), orderBy('createdAt','desc'), limit(CHAT_PAGE_SIZE));
  const cursor = chatCursors[page-1]; if(cursor) qref = query(qref, startAfter(cursor));
  const snap = await getDocs(qref);
  const docs = snap.docs; if(docs.length) chatCursors[page] = docs[docs.length-1];

  chatList.innerHTML='';
  if(!docs.length){ chatList.innerHTML='<div class="empty">더 이상 메시지가 없습니다.</div>'; }
  else docs.forEach(d=>{
    const x=d.data();
    const el=document.createElement('div'); el.className='row';
    el.innerHTML=`<div>
      <div class="muted">${fmt(x.createdAt)} · <span class="badge">${esc(x.senderName||'익명')}</span> · <span class="muted">${esc(d.id)}</span></div>
      <div>${esc(x.text||'')}</div>
    </div>
    <div><button class="btn danger" data-del="${d.id}">삭제</button></div>`;
    el.querySelector(`[data-del="${d.id}"]`).onclick=async()=>{
      if(!confirm('이 메시지를 삭제할까요?')) return;
      await deleteDoc(doc(db,'rooms','global','messages',d.id)).catch(console.error);
      el.remove();
    };
    chatList.appendChild(el);
  });
  chatPage=page; chatPageLbl.textContent=String(chatPage);
}

/* ===== 댓글/답글 ===== */
const cmPostIdEl=$('cm-postid'), cmLoadBtn=$('cm-load'), cmList=$('cm-list'), cmDelAll=$('cm-del-all');
cmLoadBtn.onclick = ()=>loadCommentsOfPost(cmPostIdEl.value.trim());
cmDelAll.onclick = async ()=>{
  const postId = cmPostIdEl.value.trim();
  if(!postId) return alert('게시글 ID를 입력하세요.');
  if(!confirm('이 게시글의 댓글/답글을 전부 삭제할까요?')) return;
  await deleteSubcollectionDeep(['communityPosts', postId, 'comments'], 100, async (cmtId)=>{
    await deleteSubcollectionDeep(['communityPosts', postId, 'comments', cmtId, 'replies'], 200);
  });
  await loadCommentsOfPost(postId);
};
async function loadCommentsOfPost(postId){
  if(!postId) return alert('게시글 ID를 입력하세요.');
  cmList.innerHTML='<div class="empty">불러오는 중…</div>';
  const snap = await getDocs(query(collection(db,'communityPosts',postId,'comments'), orderBy('createdAt','asc'), limit(500)));
  cmList.innerHTML='';
  if(snap.empty){ cmList.innerHTML='<div class="empty">댓글이 없습니다.</div>'; return; }
  for (const cDoc of snap.docs){
    const c=cDoc.data();
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<div>
      <div class="muted">댓글 · ${fmt(c.createdAt)} · ${esc(c.authorName||'익명')} · <span class="muted">${esc(cDoc.id)}</span></div>
      <div>${esc(c.text||'')}</div>
      <div id="rep-${cDoc.id}" class="list" style="margin-top:8px"><div class="muted">대댓글 불러오는 중…</div></div>
    </div>
    <div class="row-compact"><button class="btn danger" data-cdel="${cDoc.id}">댓글 삭제</button></div>`;
    cmList.appendChild(row);

    row.querySelector(`[data-cdel="${cDoc.id}"]`).onclick=async()=>{
      if(!confirm('이 댓글과 하위 답글을 삭제할까요?')) return;
      await deleteSubcollectionDeep(['communityPosts', postId, 'comments', cDoc.id, 'replies'], 200);
      await deleteDoc(doc(db,'communityPosts',postId,'comments',cDoc.id));
      row.remove();
    };

    const repList=row.querySelector(`#rep-${cDoc.id}`);
    const repSnap=await getDocs(query(collection(db,'communityPosts',postId,'comments',cDoc.id,'replies'), orderBy('createdAt','asc'), limit(500)));
    repList.innerHTML='';
    if(repSnap.empty){ repList.innerHTML='<div class="muted">대댓글 없음</div>'; }
    else repSnap.forEach(r=>{
      const rv=r.data();
      const rrow=document.createElement('div'); rrow.className='row';
      rrow.innerHTML=`<div>
        <div class="muted">↳ 답글 · ${fmt(rv.createdAt)} · ${esc(rv.authorName||'익명')} · <span class="muted">${esc(r.id)}</span></div>
        <div>${esc(rv.text||'')}</div>
      </div>
      <div><button class="btn danger" data-rdel="${r.id}">답글 삭제</button></div>`;
      rrow.querySelector(`[data-rdel="${r.id}"]`).onclick=async()=>{
        if(!confirm('이 답글을 삭제할까요?')) return;
        await deleteDoc(doc(db,'communityPosts',postId,'comments',cDoc.id,'replies',r.id));
        rrow.remove();
      };
      repList.appendChild(rrow);
    });
  }
}

/* ===== 사용자/밴 & 관리자 ===== */
const uInfo=$('u-info'), uNick=$('u-nick'), uFindNick=$('u-find-nick'), uUid=$('u-uid'), uFindUid=$('u-find-uid');
const banReason=$('ban-reason'), banDays=$('ban-days'), uBan=$('u-ban'), uUnban=$('u-unban');
let currentUserId=null;

uFindNick.onclick = async () => {
  try {
    const raw = uNick.value.trim();
    if (!raw) return alert('별명을 입력하세요.');
    const key = raw.toLowerCase();
    const mapSnap = await getDoc(doc(db,'nicknames', key));
    if (!mapSnap.exists()) { uInfo.innerHTML = '<div class="empty">해당 별명 없음</div>'; currentUserId=null; return; }
    const uid = mapSnap.data()?.uid;
    if (!uid) { uInfo.innerHTML='<div class="empty">nicknames 문서에 uid 필드가 없습니다.</div>'; currentUserId=null; return; }
    await showUser(uid);
  } catch (e) {
    console.error(e); alert('검색 중 오류: '+(e.message||e.code));
  }
};
uFindUid.onclick = async ()=>{ const uid=uUid.value.trim(); if(!uid) return alert('UID를 입력하세요.'); await showUser(uid); };

async function showUser(uid){
  const [uSnap, bSnap] = await Promise.all([getDoc(doc(db,'users',uid)), getDoc(doc(db,'bans',uid))]);
  const nick   = uSnap.exists()? (uSnap.data()?.nickname || '(닉네임 없음)') : '(미등록 사용자)';
  const banned = bSnap.exists() && bSnap.data()?.banned === true;
  const until = bSnap.exists() ? (bSnap.data()?.until || null) : null;
  currentUserId = uid;
  uInfo.innerHTML = `<div class="${banned?'badge':'badge'}">
    <div><b>UID:</b> ${uid}</div>
    <div><b>닉네임:</b> ${nick}</div>
    <div><b>상태:</b> ${banned? '정지됨':'정상'} ${until? `· ${new Date(until).toLocaleString()} 까지`:''}</div>
  </div>`;
}
uBan.onclick = async ()=>{
  if(!currentUserId) return alert('대상 사용자를 먼저 검색하세요.');
  const days = parseInt(banDays.value||'0',10);
  const until = days>0 ? new Date(Date.now()+days*86400000) : null;
  await setDoc(doc(db,'bans', currentUserId), {
    banned:true, reason:banReason.value||'', until: until? until : null, by:auth.currentUser?.uid||'(unknown)', at:serverTimestamp()
  }, { merge:true });
  await showUser(currentUserId);
  alert('정지 처리 완료');
};
uUnban.onclick = async ()=>{
  if(!currentUserId) return alert('대상 사용자를 먼저 검색하세요.');
  await setDoc(doc(db,'bans', currentUserId), { banned:false, reason:'', until:null, by:auth.currentUser?.uid||'(unknown)', at:serverTimestamp() }, { merge:true });
  await showUser(currentUserId);
  alert('정지 해제 완료');
};

/* ===== 관리자 ===== */
const admList=$('admin-list');
$('adm-add-nick').onclick = async ()=>{
  const nick=$('adm-nick').value.trim(); if(!nick) return alert('별명을 입력하세요.');
  const key=nick.toLowerCase(); const nSnap=await getDoc(doc(db,'nicknames', key));
  if(!nSnap.exists()) return alert('해당 별명이 없습니다.');
  await addAdmin(nSnap.data().uid, `nick:${key}`);
};
$('adm-add-uid').onclick = async ()=>{
  const uid=$('adm-uid').value.trim(); if(!uid) return alert('UID를 입력하세요.');
  await addAdmin(uid, 'uid');
};
async function addAdmin(uid, via){
  const me=auth.currentUser?.uid || '(unknown)';
  await setDoc(doc(db,'admins', uid), { at:serverTimestamp(), by:me, via }, { merge:true });
  await loadAdmins();
  $('adm-nick').value=''; $('adm-uid').value='';
}
async function loadAdmins(){
  admList.innerHTML='<div class="empty">불러오는 중…</div>';
  const snap=await getDocs(query(collection(db,'admins')));
  const items=await Promise.all(snap.docs.map(async d=>{
    const uid=d.id; let nick='(닉네임 없음)';
    try{ const u=await getDoc(doc(db,'users',uid)); if(u.exists()) nick=u.data()?.nickname||nick; }catch{}
    return { id:uid, nick, meta:d.data() };
  }));
  admList.innerHTML='';
  if(!items.length){ admList.innerHTML='<div class="empty">등록된 관리자가 없습니다.</div>'; return; }
  items.forEach(a=>{
    const el=document.createElement('div'); el.className='row';
    el.innerHTML=`<div>
      <div class="muted">UID: ${esc(a.id)} · 추가: ${fmt(a.meta?.at)}${a.meta?.by?` · by ${esc(a.meta.by)}`:''}</div>
      <div><b>${esc(a.nick)}</b></div>
    </div>
    <div><button class="btn danger" data-del="${a.id}">삭제</button></div>`;
    el.querySelector(`[data-del="${a.id}"]`).onclick=async()=>{
      if(!confirm('이 사용자를 관리자에서 제거할까요?')) return;
      await deleteDoc(doc(db,'admins', a.id)).catch(console.error);
      el.remove();
    };
    admList.appendChild(el);
  });
}

/* ===== 공통 삭제 유틸 ===== */
function toPathArray(p){ return Array.isArray(p)? p: p.split('/'); }
async function deleteCollectionDeep(pathOrArr, pageSize=100, perDocCallback=null){
  const p=toPathArray(pathOrArr); let cursor=null;
  while(true){
    let qref=query(collection(db,...p), orderBy('createdAt','asc'), limit(pageSize));
    const snap=await getDocs(cursor? query(qref,startAfter(cursor)) : qref)
      .catch(async()=>{ let q2=query(collection(db,...p), orderBy('__name__','asc'), limit(pageSize));
        return await getDocs(cursor? query(q2,startAfter(cursor)) : q2); });
    if(snap.empty) break;
    const batch=writeBatch(db);
    for(const d of snap.docs){ if(typeof perDocCallback==='function'){ await perDocCallback(d.id); } batch.delete(d.ref); }
    await batch.commit();
    cursor=snap.docs[snap.docs.length-1];
  }
}
async function deleteSubcollectionDeep(pathArr, pageSize=200, perDocCb=null){
  return await deleteCollectionDeep(pathArr, pageSize, perDocCb);
}
async function deletePostDeep(postId){
  await deleteSubcollectionDeep(['communityPosts', postId, 'comments'], 100, async (cmtId)=>{
    await deleteSubcollectionDeep(['communityPosts', postId, 'comments', cmtId, 'replies'], 200);
  });
  await deleteSubcollectionDeep(['communityPosts', postId, 'likes'], 200);
  await deleteDoc(doc(db,'communityPosts',postId));
}

/* ===== 이송(Transport) 로직 ===== */
const tpModal = $('tpModal');
const tpOpen = $('btn-tp-new');
const tpCancel = $('tp-cancel');
const tpSave = $('tp-save');
const kpiQ=$('kpi-q'), kpiA=$('kpi-a'), kpiP=$('kpi-p'), kpiD=$('kpi-d'), tpTotal=$('tp-total');

tpOpen.onclick = ()=>{ tpModal.style.display='flex'; tpModal.setAttribute('aria-hidden','false'); };
tpCancel.onclick = ()=>{ tpModal.style.display='none'; tpModal.setAttribute('aria-hidden','true'); };
tpModal.addEventListener('click',e=>{ if(e.target===tpModal) tpCancel.click(); });

$('btn-tp-refresh').onclick = loadTransportBoard;

async function loadTransportBoard(){
  const today0 = new Date(); today0.setHours(0,0,0,0);
  const today1 = new Date(); today1.setHours(23,59,59,999);

  const [qSnap,aSnap,p1Snap,p2Snap,dSnap] = await Promise.all([
    getDocs(query(collection(db,'transports'), where('status','==','queued'), orderBy('createdAt','asc'))),
    getDocs(query(collection(db,'transports'), where('status','==','assigned'), orderBy('createdAt','asc'))),
    getDocs(query(collection(db,'transports'), where('status','==','pickup'), orderBy('createdAt','asc'))),
    getDocs(query(collection(db,'transports'), where('status','==','enroute'), orderBy('createdAt','asc'))),
    getDocs(query(collection(db,'transports'), where('status','==','done'), orderBy('createdAt','desc')))
  ]);

  const colQ=$('col-queued'), colA=$('col-assigned'), colP=$('col-progress'), colD=$('col-done');
  colQ.innerHTML=''; colA.innerHTML=''; colP.innerHTML=''; colD.innerHTML='';

  let total=0, cQ=0,cA=0,cP=0,cD=0;

  const addCard=(whereEl, docId, x)=>{
    total++;
    const el=document.createElement('div'); el.className='card-tp';
    const pri = x.priority==='STAT' ? 'chip stat' : 'chip';
    const tchip = x.type==='bed' ? 'chip bed' : (x.type==='wheelchair'?'chip wheel':'chip iso');
    el.innerHTML = `
      <div class="tp-head">
        <div class="tp-meta">
          <span class="${pri}">${esc(x.priority)}</span>
          <span class="${tchip}">${esc(x.type)}</span>
          ${(x.assignedTo?.name)?`<span class="chip">포터: ${esc(x.assignedTo.name)}</span>`:''}
        </div>
        <span class="badge">#${docId.slice(0,5)}</span>
      </div>
      <div class="tp-line"><b>${esc(x.patient?.name||'환자')}</b> <span class="muted">(${esc(x.patient?.id||'ID없음')})</span></div>
      <div class="tp-line">${esc(x.from)} <span class="muted">→</span> ${esc(x.to)}</div>
      ${x.notes?`<div class="tp-line muted">메모: ${esc(x.notes)}</div>`:''}
      <div class="tp-actions"></div>
    `;
    const actions = el.querySelector('.tp-actions');

    if(x.status==='queued'){
      const b1=document.createElement('button'); b1.className='btn primary'; b1.textContent='배정'; b1.onclick=()=>openPorterModal(docId); actions.appendChild(b1);
      const b2=document.createElement('button'); b2.className='btn danger'; b2.textContent='취소'; b2.onclick=()=>updateDoc(doc(db,'transports',docId),{status:'canceled',updatedAt:serverTimestamp()}).then(loadTransportBoard); actions.appendChild(b2);
      cQ++;
    }else if(x.status==='assigned'){
      const b1=document.createElement('button'); b1.className='btn primary'; b1.textContent='픽업 시작'; b1.onclick=()=>updateDoc(doc(db,'transports',docId),{status:'pickup',updatedAt:serverTimestamp()}).then(loadTransportBoard);
      actions.appendChild(b1);
      cA++;
    }else if(x.status==='pickup'){
      const b1=document.createElement('button'); b1.className='btn primary'; b1.textContent='출발'; b1.onclick=()=>updateDoc(doc(db,'transports',docId),{status:'enroute',updatedAt:serverTimestamp()}).then(loadTransportBoard);
      actions.appendChild(b1);
      cP++;
    }else if(x.status==='enroute'){
      const b1=document.createElement('button'); b1.className='btn primary'; b1.textContent='완료'; b1.onclick=()=>updateDoc(doc(db,'transports',docId),{status:'done',doneAt:serverTimestamp(),updatedAt:serverTimestamp()}).then(loadTransportBoard);
      actions.appendChild(b1);
      cP++;
    }else if(x.status==='done'){
      const doneAt=x.doneAt?.toDate?.()||null;
      if(doneAt && doneAt>=today0 && doneAt<=today1) cD++;
    }
    whereEl.appendChild(el);
  };

  qSnap.forEach(d=>addCard(colQ,d.id,d.data()));
  aSnap.forEach(d=>addCard(colA,d.id,d.data()));
  p1Snap.forEach(d=>addCard(colP,d.id,d.data()));
  p2Snap.forEach(d=>addCard(colP,d.id,d.data()));
  dSnap.forEach(d=>addCard(colD,d.id,d.data()));

  if(!colQ.children.length) colQ.innerHTML='<div class="slot">대기 없음</div>';
  if(!colA.children.length) colA.innerHTML='<div class="slot">배정 없음</div>';
  if(!colP.children.length) colP.innerHTML='<div class="slot">진행중 없음</div>';
  if(!colD.children.length) colD.innerHTML='<div class="slot">완료 없음</div>';

  kpiQ.textContent=cQ; kpiA.textContent=cA; kpiP.textContent=cP; kpiD.textContent=cD;
  tpTotal.textContent = `${total}건`;
}

// 이송 저장
tpSave.onclick = async ()=>{
  const pid=$('tp-pid').value.trim();
  const pname=$('tp-pname').value.trim();
  const from=$('tp-from').value.trim();
  const to=$('tp-to').value.trim();
  const pri=$('tp-pri').value;
  const type=$('tp-type').value;
  const sched=$('tp-sched').value? new Date($('tp-sched').value) : null;
  const notes=$('tp-notes').value.trim();
  if(!from || !to){ alert('출발지/도착지를 입력하세요'); return; }
  try{
    function normPriority(v){ return (v==='긴급'||v==='STAT')?'STAT':'Routine'; }
    function normType(v){ if(v==='휠체어'||v==='wheelchair') return 'wheelchair'; if(v==='격리'||v==='isolation') return 'isolation'; return 'bed'; }
    await addDoc(collection(db,'transports'),{
      createdAt: serverTimestamp(),
      status:'queued',
      from, to, priority: normPriority(pri), type: normType(type),
      scheduledAt: sched? sched : null,
      notes: notes || null,
      patient: { id: pid||'', name: pname||'' }
    });
    tpCancel.click();
    ['tp-pid','tp-pname','tp-from','tp-to','tp-notes','tp-sched'].forEach(id=>$(id).value='');
    $('tp-pri').value='Routine'; $('tp-type').value='bed';
    await loadTransportBoard();
  }catch(e){ err(e); }
};

/* ===== 포터 목록 모달 ===== */
let PICK_TARGET_REQID = null;
let PORTERS = [];
let PRESENCE = {};
let serverNow = Date.now();
const FRESH_MS=120000;

const porterUI = {
  root: $('porterPicker'),
  list: $('porterList'),
  q: $('porterQuery'),
  btnCancel: $('porterCancel'),
};
onValue(ref(rtdb,'.info/serverTimeOffset'), s=>{ serverNow = Date.now() + (s.val()||0); });
onValue(ref(rtdb,'presence/global'), snap=>{ PRESENCE=snap.val()||{}; if(porterUI.root.style.display==='flex') renderPorterList(); });

async function loadPorters(){
  const ps = await getDocs(collection(db,'porters'));
  const items=[];
  for(const d of ps.docs){
    const uid=d.id;
    let name='(이름없음)';
    try{ const us=await getDoc(doc(db,'users',uid)); if(us.exists()) name=us.data()?.nickname||name; }catch{}
    const pv=PRESENCE?.[uid];
    const online=!!(pv && Number.isFinite(pv.at) && (serverNow - pv.at) < FRESH_MS);
    items.push({uid,name,online});
  }
  items.sort((a,b)=> (b.online - a.online) || a.name.localeCompare(b.name,'ko'));
  PORTERS=items;
}
function renderPorterList(){
  const q=(porterUI.q.value||'').trim().toLowerCase();
  const rows=PORTERS.filter(p=> !q || p.name.toLowerCase().includes(q) || p.uid.toLowerCase().includes(q));
  porterUI.list.innerHTML='';
  if(!rows.length){ porterUI.list.innerHTML='<div class="empty">결과가 없습니다.</div>'; return; }
  rows.forEach(p=>{
    const el=document.createElement('div'); el.className='porter-item';
    el.innerHTML=`
      <div class="porter-meta">
        <span class="porter-dot ${p.online?'on':'off'}"></span>
        <strong>${esc(p.name)}</strong>
        <span class="badge" title="UID">${esc(p.uid)}</span>
      </div>
      <div><button class="btn primary" data-pick="${p.uid}">배정</button></div>
    `;
    el.querySelector('[data-pick]').onclick=()=>assignToPorter(PICK_TARGET_REQID,p);
    porterUI.list.appendChild(el);
  });
}
function openPorterModal(reqId){
  PICK_TARGET_REQID=reqId;
  porterUI.root.style.display='flex'; porterUI.root.setAttribute('aria-hidden','false');
  porterUI.q.value=''; porterUI.list.innerHTML='<div class="empty">목록 불러오는 중…</div>';
  loadPorters().then(renderPorterList);
}
function closePorterModal(){ porterUI.root.style.display='none'; porterUI.root.setAttribute('aria-hidden','true'); PICK_TARGET_REQID=null; }
porterUI.btnCancel.onclick=closePorterModal;
porterUI.root.addEventListener('click',e=>{ if(e.target===porterUI.root) closePorterModal(); });
porterUI.q.addEventListener('input',renderPorterList);

async function assignToPorter(reqId, porter){
  if(!reqId) return;
  try{
    await updateDoc(doc(db,'transports',reqId),{
      assignedTo: { uid: porter.uid, name: porter.name },
      status:'assigned',
      updatedAt: serverTimestamp()
    });
    closePorterModal();
    await loadTransportBoard();
    alert(`배정 완료: ${porter.name}`);
  }catch(e){ err(e); }
}

/* ===== 탭 스위치 ===== */
[['tab-home','panel-home'],['tab-transport','panel-transport'],['tab-posts','panel-posts'],['tab-chat','panel-chat'],['tab-comments','panel-comments'],['tab-users','panel-users'],['tab-admin','panel-admin']]
  .forEach(([tid,pid])=>{
    const t=$(tid), p=$(pid); if(!t) return;
    t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(btn=>btn.classList.remove('active'));
      document.querySelectorAll('#admin-app section.card').forEach(sec=>sec.style.display='none');
      t.classList.add('active'); p.style.display='block';
      if(pid==='panel-transport') loadTransportBoard();
    };
  });
</script>
</body>
</html>
