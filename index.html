<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Freetalk</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f7f8fb;--ink:#0f1724;--muted:#6b7280;--accent:#6d28d9;--accent2:#7c3aed;--danger:#ef4444;--bd:#e5e7eb;--radius:12px;--max:1120px}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Malgun Gothic,sans-serif}

    /* 공통 */
    .wrap{max-width:var(--max);margin:18px auto;padding:12px}
    header.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .brand{display:flex;gap:10px;align-items:center;text-decoration:none;color:inherit}
    .nav{display:flex;gap:8px;align-items:center}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--bd);background:#fff;color:#111;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border:0}
    .btn.danger{background:var(--danger);color:#fff;border:0}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--bd);background:#f8fafc;font-size:12px;color:#374151}
    .card{background:#fff;border:1px solid var(--bd);border-radius:12px;box-shadow:0 8px 26px rgba(2,6,23,.06);padding:14px}

    /* 관리자 대시보드 전용 */
    .tabs{display:flex;gap:8px;margin:8px 0 12px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:10px;border:1px solid var(--bd);background:#fff;cursor:pointer}
    .tab.active{background:var(--accent);color:#fff;border-color:transparent}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px;flex-wrap:wrap}
    .list{display:flex;flex-direction:column;gap:10px}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:flex-start;border:1px solid #eef;border-radius:10px;padding:12px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .title{font-weight:700}
    .content{white-space:pre-wrap;line-height:1.55}
    .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
    .empty{color:var(--muted);text-align:center;padding:18px;background:#fafbff;border-radius:10px;border:1px dashed #e5e7eb}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    @media(min-width:900px){ .grid2{grid-template-columns:1fr 1fr} .grid3{grid-template-columns:1fr 1fr 1fr} }
    .field{padding:10px;border:1px solid var(--bd);border-radius:10px;background:#fff;width:100%}
    .row-compact{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .warn{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;border-radius:10px;padding:8px 10px;font-size:13px}
    .ok{background:#ecfeff;border:1px solid #67e8f9;color:#155e75;border-radius:10px;padding:8px 10px;font-size:13px}
    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:12px}
    .kpi .tile{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px}
    .kpi .num{font-size:22px;font-weight:700}

    /* 일반 홈 전용 */
    .hero{padding:24px;border:1px solid var(--bd);border-radius:14px;background:#fff;box-shadow:0 8px 26px rgba(2,6,23,.06)}
    .hero h1{margin:0 0 8px}
    .hero p{color:var(--muted);margin:4px 0 14px}
    .cta{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>

<!-- ▷ 일반 사용자에게 보이는 홈 -->
<div id="public-home" class="wrap" style="display:none">
  <header class="top">
    <a class="brand" href="/index.html"><strong>Freetalk</strong></a>
    <nav class="nav">
      <a class="btn" href="/community.html">커뮤니티</a>
      <a class="btn" href="/chat.html">채팅</a>
      <button id="logout1" class="btn">로그아웃</button>
    </nav>
  </header>

  <section class="hero">
    <h1>자유롭게 소통하는 온라인 커뮤니티</h1>
    <p>로그인한 사용자는 글/댓글/채팅이 가능합니다.</p>
    <div class="cta">
      <a class="btn primary" href="/chat.html">바로 채팅하기</a>
      <a class="btn" href="/community.html">커뮤니티 둘러보기</a>
      <span id="admin-shortcut" class="badge" style="display:none">관리자 계정입니다 · 상단 “관리자” 메뉴로 이동하세요</span>
    </div>
  </section>
</div>

<!-- ▷ 관리자에게만 보이는 대시보드 -->
<div id="admin-app" class="wrap" style="display:none">
  <header class="top">
    <a class="brand" href="/index.html"><strong>Freetalk</strong> <span class="badge">관리자 대시보드</span></a>
    <nav class="nav">
      <a class="btn" href="/community.html">커뮤니티</a>
      <a class="btn" href="/chat.html">채팅</a>
      <button id="logout2" class="btn">로그아웃</button>
    </nav>
  </header>

  <div class="tabs">
    <button id="tab-home" class="tab active">요약</button>
    <button id="tab-posts" class="tab">게시글</button>
    <button id="tab-chat"  class="tab">채팅</button>
    <button id="tab-comments" class="tab">댓글/답글</button>
    <button id="tab-users" class="tab">사용자/밴</button>
    <button id="tab-admin" class="tab">관리자</button>
  </div>

  <!-- 요약 -->
  <section id="panel-home" class="card">
    <div class="toolbar">
      <strong>개요</strong>
      <span class="muted">전체 현황 요약 · 최근 게시글/채팅 5개</span>
    </div>
    <div class="kpi">
      <div class="tile"><div class="muted">게시글</div><div id="kpi-posts" class="num">-</div></div>
      <div class="tile"><div class="muted">댓글</div><div id="kpi-comments" class="num">-</div></div>
      <div class="tile"><div class="muted">채팅</div><div id="kpi-chats" class="num">-</div></div>
      <div class="tile"><div class="muted">사용자</div><div id="kpi-users" class="num">-</div></div>
    </div>
    <div class="grid2">
      <div>
        <div class="muted" style="margin-bottom:6px">최근 게시글</div>
        <div id="home-posts" class="list"><div class="empty">불러오는 중…</div></div>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">최근 채팅</div>
        <div id="home-chats" class="list"><div class="empty">불러오는 중…</div></div>
      </div>
    </div>
  </section>

  <!-- 게시글 -->
  <section id="panel-posts" class="card" style="display:none">
    <div class="toolbar">
      <div class="row-compact">
        <strong>게시글</strong>
        <span id="post-count" class="badge">0</span>
        <span class="muted">(페이지당 10개)</span>
      </div>
      <div class="row-compact">
        <button id="post-del-page" class="btn danger">이 페이지 모두 삭제</button>
        <button id="post-del-all"  class="btn danger">전체 게시글 삭제(위험)</button>
        <div class="pager">
          <button id="post-prev" class="btn">이전</button>
          <span class="badge" id="post-page">1 / 1</span>
          <button id="post-next" class="btn">다음</button>
        </div>
      </div>
    </div>
    <div id="post-list" class="list"><div class="empty">불러오는 중…</div></div>
  </section>

  <!-- 채팅 -->
  <section id="panel-chat" class="card" style="display:none">
    <div class="toolbar">
      <div class="row-compact">
        <strong>채팅 메시지</strong>
        <span class="muted">개별 삭제 또는 전체 삭제</span>
      </div>
      <div class="row-compact">
        <button id="chat-del-all" class="btn danger">전체 채팅 삭제(위험)</button>
        <div class="pager">
          <button id="chat-prev" class="btn">이전</button>
          <span class="badge" id="chat-page">1</span>
          <button id="chat-next" class="btn">다음</button>
        </div>
      </div>
    </div>
    <div id="chat-list" class="list"><div class="empty">불러오는 중…</div></div>
  </section>

  <!-- 댓글/답글 -->
  <section id="panel-comments" class="card" style="display:none">
    <div class="toolbar">
      <div class="row-compact">
        <strong>댓글/답글 관리</strong>
        <span class="muted">게시글 ID를 입력해 댓글/답글을 조회·삭제</span>
      </div>
      <div class="grid3" style="align-items:center">
        <input id="cm-postid" class="field" placeholder="communityPosts/{postId}">
        <button id="cm-load" class="btn">불러오기</button>
        <button id="cm-del-all" class="btn danger">이 글의 댓글/답글 전체 삭제</button>
      </div>
    </div>
    <div id="cm-list" class="list"><div class="empty">게시글 ID를 입력한 뒤 불러오기를 누르세요.</div></div>
  </section>

  <!-- 사용자/밴 -->
  <section id="panel-users" class="card" style="display:none">
    <div class="toolbar">
      <div><strong>사용자 검색/밴</strong></div>
      <div class="muted">별명 또는 UID로 조회 → 밴(정지)/해제</div>
    </div>
    <div class="grid2" style="margin-bottom:8px">
      <div class="row-compact">
        <input id="u-nick" class="field" placeholder="별명으로 검색">
        <button id="u-find-nick" class="btn">검색</button>
      </div>
      <div class="row-compact">
        <input id="u-uid" class="field" placeholder="UID로 검색">
        <button id="u-find-uid" class="btn">검색</button>
      </div>
    </div>
    <div class="grid2" style="margin-bottom:10px">
      <input id="ban-reason" class="field" placeholder="정지 사유(선택)">
      <div class="row-compact">
        <input id="ban-days" class="field" type="number" min="0" placeholder="정지 일수(0=영구)">
        <button id="u-ban" class="btn danger">정지</button>
        <button id="u-unban" class="btn">정지 해제</button>
      </div>
    </div>
    <div id="u-info" class="list"><div class="empty">검색 결과가 여기에 표시됩니다.</div></div>
    <div class="warn" style="margin-top:10px">
      ⚠️ Firestore 보안규칙에서 <code>bans/{uid}.banned</code>와 <code>until</code>을 검사해 생성(create)을 차단해야 밴이 강제됩니다.
    </div>
  </section>

  <!-- 관리자 -->
  <section id="panel-admin" class="card" style="display:none">
    <div class="toolbar">
      <div><strong>관리자 설정</strong></div>
      <span class="muted">별명 또는 UID로 추가 · 목록에서 삭제</span>
    </div>
    <div class="grid2" style="margin-bottom:10px">
      <div class="row-compact">
        <input id="adm-nick" class="field" placeholder="별명 입력(예: 개발자)">
        <button id="adm-add-nick" class="btn primary">별명으로 추가</button>
      </div>
      <div class="row-compact">
        <input id="adm-uid" class="field" placeholder="UID 직접 입력">
        <button id="adm-add-uid" class="btn">UID로 추가</button>
      </div>
    </div>
    <div class="muted" style="margin:-6px 0 12px">※ 별명 추가는 <code>nicknames/{별명소문자}</code>에서 UID를 찾아 등록합니다.</div>
    <div id="admin-list" class="list"><div class="empty">관리자 목록 불러오는 중…</div></div>
  </section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import {
  getFirestore, collection, query, orderBy, limit, startAfter, getDocs, doc, deleteDoc, getDoc, setDoc,
  getCountFromServer, serverTimestamp, writeBatch
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* ===== Firebase ===== */
const cfg = {
  apiKey:"AIzaSyACn_-2BLztKYmBKXtrKNtMsC-2Y238oug",
  authDomain:"woori-1ecf5.firebaseapp.com",
  projectId:"woori-1ecf5",
  storageBucket:"woori-1ecf5.firebasestorage.app",
  messagingSenderId:"1073097361525",
  appId:"1:1073097361525:web:3218ced6a040aaaf4d503c",
  databaseURL:"https://woori-1ecf5-default-rtdb.firebaseio.com"
};
const app = initializeApp(cfg);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ===== DOM ===== */
const $ = (id)=>document.getElementById(id);
const adminApp   = $('admin-app');
const publicHome = $('public-home');
const logout1 = $('logout1');
const logout2 = $('logout2');

function showPublic(isAdmin=false){
  adminApp.style.display = 'none';
  publicHome.style.display = 'block';
  const tip = document.getElementById('admin-shortcut');
  if(tip) tip.style.display = isAdmin ? 'inline-block' : 'none';
}
function showAdmin(){
  publicHome.style.display = 'none';
  adminApp.style.display   = 'block';
}

onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.replace('/login.html'); return; }
  try{
    const a = await getDoc(doc(db,'admins', u.uid));
    if(!a.exists()){
      // 비관리자: 대시보드 숨기고 일반 홈 노출 (팝업 없음)
      showPublic(false);
      return;
    }
    // 관리자: 대시보드 열고 데이터 로드
    showAdmin();
    await Promise.all([loadHome(), loadPostPage(1), loadChatPage(1), loadAdmins()]);
  }catch(e){
    console.error(e);
    showPublic(false);
  }
});
const doLogout = ()=>signOut(auth);
if(logout1) logout1.onclick = doLogout;
if(logout2) logout2.onclick = doLogout;

/* ===== 유틸 ===== */
const esc = s=>String(s||'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
const fmt = ts=>{
  try{
    if(ts?.toDate) return ts.toDate().toLocaleString();
    if(typeof ts==='string') return new Date(ts).toLocaleString();
    return '';
  }catch{ return ''; }
};

/* ===== 홈(요약) ===== */
async function countCol(pathArr){
  const ref = collection(db, ...pathArr);
  const snap = await getCountFromServer(ref);
  return snap.data().count || 0;
}
async function loadHome(){
  $('kpi-posts').textContent   = await countCol(['communityPosts']);
  $('kpi-comments').textContent= await countCol(['communityPosts']);
  $('kpi-chats').textContent   = await countCol(['rooms','global','messages']);
  $('kpi-users').textContent   = await countCol(['users']);

  const pSnap = await getDocs(query(collection(db,'communityPosts'), orderBy('createdAt','desc'), limit(5)));
  const homePosts = $('home-posts'); homePosts.innerHTML='';
  if(pSnap.empty){ homePosts.innerHTML='<div class="empty">최근 게시글 없음</div>'; }
  else pSnap.forEach(d=>{
    const x=d.data();
    const el=document.createElement('div'); el.className='row';
    el.innerHTML=`<div>
      <div class="meta">${fmt(x.createdAt)} · <span class="badge">${esc(x.authorName||'익명')}</span></div>
      <div class="title">${esc(x.title||'(제목 없음)')}</div>
      <div class="content">${esc(x.body||'')}</div>
    </div>
    <div><button class="btn danger" data-del="${d.id}">삭제</button></div>`;
    el.querySelector(`[data-del="${d.id}"]`).onclick=()=>deletePostDeep(d.id).catch(console.error).then(()=>el.remove());
    homePosts.appendChild(el);
  });

  const cSnap = await getDocs(query(collection(db,'rooms','global','messages'), orderBy('createdAt','desc'), limit(5)));
  const homeChats = $('home-chats'); homeChats.innerHTML='';
  if(cSnap.empty){ homeChats.innerHTML='<div class="empty">최근 채팅 없음</div>'; }
  else cSnap.forEach(d=>{
    const x=d.data();
    const el=document.createElement('div'); el.className='row';
    el.innerHTML=`<div>
      <div class="meta">${fmt(x.createdAt)} · <span class="badge">${esc(x.senderName||'익명')}</span> · <span class="muted">${esc(d.id)}</span></div>
      <div class="content">${esc(x.text||'')}</div>
    </div>
    <div><button class="btn danger" data-cdel="${d.id}">삭제</button></div>`;
    el.querySelector(`[data-cdel="${d.id}"]`).onclick=()=>deleteDoc(doc(db,'rooms','global','messages',d.id)).catch(console.error).then(()=>el.remove());
    homeChats.appendChild(el);
  });
}

/* ===== 게시글 ===== */
const POST_PAGE_SIZE=10;
let postPage=1, postTotalPages=1;
let postCursors=[null];
const postList=$('post-list'), postCnt=$('post-count'), postPageLbl=$('post-page');
$('post-prev').onclick=()=>{ if(postPage>1) loadPostPage(postPage-1); };
$('post-next').onclick=()=>{ if(postPage<postTotalPages) loadPostPage(postPage+1); };
$('post-del-page').onclick=async()=>{
  const ids=[...postList.querySelectorAll('[data-id]')].map(el=>el.getAttribute('data-id'));
  if(!ids.length) return;
  if(!confirm('현재 페이지의 게시글을 모두 삭제할까요? (댓글/답글/좋아요 포함)')) return;
  for(const id of ids){ await deletePostDeep(id).catch(console.error); }
  await loadPostPage(postPage);
};
$('post-del-all').onclick=async()=>{
  if(!confirm('정말 전체 게시글을 삭제할까요? 되돌릴 수 없습니다.')) return;
  await deleteCollectionDeep(['communityPosts'], 50, async (postId)=>{ await deletePostDeep(postId); });
  await loadPostPage(1);
};
async function loadPostPage(page){
  postList.innerHTML='<div class="empty">불러오는 중…</div>';
  const agg = await getCountFromServer(collection(db,'communityPosts'));
  const total = agg.data().count||0; postCnt.textContent = total;
  postTotalPages = Math.max(1, Math.ceil(total/POST_PAGE_SIZE));

  let qref = query(collection(db,'communityPosts'), orderBy('createdAt','desc'), limit(POST_PAGE_SIZE));
  const cursor = postCursors[page-1]; if(cursor) qref = query(qref, startAfter(cursor));
  const snap = await getDocs(qref);
  const docs = snap.docs; if(docs.length) postCursors[page] = docs[docs.length-1];

  postList.innerHTML='';
  if(!docs.length){ postList.innerHTML='<div class="empty">표시할 게시글이 없습니다.</div>'; }
  else docs.forEach(d=>{
    const x=d.data();
    const el=document.createElement('div'); el.className='row'; el.setAttribute('data-id', d.id);
    el.innerHTML=`<div>
      <div class="meta">${fmt(x.createdAt)} · <span class="badge">${esc(x.authorName||'익명')}</span></div>
      <div class="title">${esc(x.title||'(제목 없음)')}</div>
      <div class="content">${esc(x.body||'')}</div>
    </div>
    <div class="row-compact">
      <button class="btn" data-open-comments="${d.id}">댓글 보기</button>
      <button class="btn danger" data-del="${d.id}">삭제</button>
    </div>`;
    el.querySelector(`[data-open-comments="${d.id}"]`).onclick=()=>{
      document.getElementById('tab-comments').click();
      document.getElementById('cm-postid').value=d.id; document.getElementById('cm-load').click();
    };
    el.querySelector(`[data-del="${d.id}"]`).onclick=async()=>{
      if(!confirm('이 게시글과 하위 댓글/답글/좋아요를 모두 삭제할까요?')) return;
      await deletePostDeep(d.id).catch(console.error); el.remove();
    };
    postList.appendChild(el);
  });

  postPage=page; postPageLbl.textContent=`${postPage} / ${postTotalPages}`;
}

/* ===== 채팅 ===== */
const CHAT_PAGE_SIZE=30;
let chatPage=1; let chatCursors=[null];
const chatList=$('chat-list'), chatPageLbl=$('chat-page');
$('chat-prev').onclick=()=>{ if(chatPage>1) loadChatPage(chatPage-1); };
$('chat-next').onclick=()=>{ loadChatPage(chatPage+1); };
$('chat-del-all').onclick=async()=>{
  if(!confirm('정말 전체 채팅 메시지를 삭제할까요?')) return;
  await deleteCollectionDeep(['rooms','global','messages'], 100);
  await loadChatPage(1);
};
async function loadChatPage(page){
  chatList.innerHTML='<div class="empty">불러오는 중…</div>';
  let qref = query(collection(db,'rooms','global','messages'), orderBy('createdAt','desc'), limit(CHAT_PAGE_SIZE));
  const cursor = chatCursors[page-1]; if(cursor) qref = query(qref, startAfter(cursor));
  const snap = await getDocs(qref);
  const docs = snap.docs; if(docs.length) chatCursors[page] = docs[docs.length-1];

  chatList.innerHTML='';
  if(!docs.length){ chatList.innerHTML='<div class="empty">더 이상 메시지가 없습니다.</div>'; }
  else docs.forEach(d=>{
    const x=d.data();
    const el=document.createElement('div'); el.className='row';
    el.innerHTML=`<div>
      <div class="meta">${fmt(x.createdAt)} · <span class="badge">${esc(x.senderName||'익명')}</span> · <span class="muted">${esc(d.id)}</span></div>
      <div class="content">${esc(x.text||'')}</div>
    </div>
    <div><button class="btn danger" data-del="${d.id}">삭제</button></div>`;
    el.querySelector(`[data-del="${d.id}"]`).onclick=async()=>{
      if(!confirm('이 메시지를 삭제할까요?')) return;
      await deleteDoc(doc(db,'rooms','global','messages',d.id)).catch(console.error);
      el.remove();
    };
    chatList.appendChild(el);
  });
  chatPage=page; chatPageLbl.textContent=String(chatPage);
}

/* ===== 댓글/답글 ===== */
const cmPostIdEl=$('cm-postid'), cmLoadBtn=$('cm-load'), cmList=$('cm-list'), cmDelAll=$('cm-del-all');
cmLoadBtn.onclick = ()=>loadCommentsOfPost(cmPostIdEl.value.trim());
cmDelAll.onclick = async ()=>{
  const postId = cmPostIdEl.value.trim();
  if(!postId) return alert('게시글 ID를 입력하세요.');
  if(!confirm('이 게시글의 댓글/답글을 전부 삭제할까요?')) return;
  await deleteSubcollectionDeep(['communityPosts', postId, 'comments'], 100, async (cmtId)=>{
    await deleteSubcollectionDeep(['communityPosts', postId, 'comments', cmtId, 'replies'], 200);
  });
  await loadCommentsOfPost(postId);
};
async function loadCommentsOfPost(postId){
  if(!postId) return alert('게시글 ID를 입력하세요.');
  cmList.innerHTML='<div class="empty">불러오는 중…</div>';
  const snap = await getDocs(query(collection(db,'communityPosts',postId,'comments'), orderBy('createdAt','asc'), limit(500)));
  cmList.innerHTML='';
  if(snap.empty){ cmList.innerHTML='<div class="empty">댓글이 없습니다.</div>'; return; }
  for (const cDoc of snap.docs){
    const c=cDoc.data();
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<div>
      <div class="meta">댓글 · ${fmt(c.createdAt)} · ${esc(c.authorName||'익명')} · <span class="muted">${esc(cDoc.id)}</span></div>
      <div class="content">${esc(c.text||'')}</div>
      <div id="rep-${cDoc.id}" class="list" style="margin-top:8px"><div class="muted">대댓글 불러오는 중…</div></div>
    </div>
    <div class="row-compact"><button class="btn danger" data-cdel="${cDoc.id}">댓글 삭제</button></div>`;
    cmList.appendChild(row);

    row.querySelector(`[data-cdel="${cDoc.id}"]`).onclick=async()=>{
      if(!confirm('이 댓글과 하위 답글을 삭제할까요?')) return;
      await deleteSubcollectionDeep(['communityPosts', postId, 'comments', cDoc.id, 'replies'], 200);
      await deleteDoc(doc(db,'communityPosts',postId,'comments',cDoc.id));
      row.remove();
    };

    const repList=row.querySelector(`#rep-${cDoc.id}`);
    const repSnap=await getDocs(query(collection(db,'communityPosts',postId,'comments',cDoc.id,'replies'), orderBy('createdAt','asc'), limit(500)));
    repList.innerHTML='';
    if(repSnap.empty){ repList.innerHTML='<div class="muted">대댓글 없음</div>'; }
    else repSnap.forEach(r=>{
      const rv=r.data();
      const rrow=document.createElement('div'); rrow.className='row';
      rrow.innerHTML=`<div>
        <div class="meta">↳ 답글 · ${fmt(rv.createdAt)} · ${esc(rv.authorName||'익명')} · <span class="muted">${esc(r.id)}</span></div>
        <div class="content">${esc(rv.text||'')}</div>
      </div>
      <div><button class="btn danger" data-rdel="${r.id}">답글 삭제</button></div>`;
      rrow.querySelector(`[data-rdel="${r.id}"]`).onclick=async()=>{
        if(!confirm('이 답글을 삭제할까요?')) return;
        await deleteDoc(doc(db,'communityPosts',postId,'comments',cDoc.id,'replies',r.id));
        rrow.remove();
      };
      repList.appendChild(rrow);
    });
  }
}

/* ===== 사용자/밴 ===== */
const uInfo=$('u-info'), uNick=$('u-nick'), uFindNick=$('u-find-nick'), uUid=$('u-uid'), uFindUid=$('u-find-uid');
const banReason=$('ban-reason'), banDays=$('ban-days'), uBan=$('u-ban'), uUnban=$('u-unban');
let currentUserId=null;

uFindNick.onclick = async () => {
  try {
    const raw = uNick.value.trim();
    if (!raw) return alert('별명을 입력하세요.');
    const key = raw.toLowerCase();
    const mapSnap = await getDoc(doc(db,'nicknames', key));
    if (!mapSnap.exists()) { uInfo.innerHTML = '<div class="empty">해당 별명 없음</div>'; currentUserId=null; return; }
    const uid = mapSnap.data()?.uid;
    if (!uid) { uInfo.innerHTML='<div class="empty">nicknames 문서에 uid 필드가 없습니다.</div>'; currentUserId=null; return; }
    await showUser(uid);
  } catch (e) {
    console.error(e); alert('검색 중 오류: '+(e.message||e.code));
  }
};
uFindUid.onclick = async ()=>{ const uid=uUid.value.trim(); if(!uid) return alert('UID를 입력하세요.'); await showUser(uid); };

async function showUser(uid){
  const [uSnap, bSnap] = await Promise.all([getDoc(doc(db,'users',uid)), getDoc(doc(db,'bans',uid))]);
  const nick   = uSnap.exists()? (uSnap.data()?.nickname || '(닉네임 없음)') : '(미등록 사용자)';
  const banned = bSnap.exists() && bSnap.data()?.banned === true;
  const until  = bSnap.exists()? (bSnap.data()?.until || null) : null;
  currentUserId = uid;
  uInfo.innerHTML = `<div class="${banned?'warn':'ok'}">
    <div><b>UID:</b> ${uid}</div>
    <div><b>닉네임:</b> ${nick}</div>
    <div><b>상태:</b> ${banned? '정지됨':'정상'} ${until? `· ${new Date(until).toLocaleString()} 까지`:''}</div>
  </div>`;
}
uBan.onclick = async ()=>{
  if(!currentUserId) return alert('대상 사용자를 먼저 검색하세요.');
  const days = parseInt(banDays.value||'0',10);
  const until = days>0 ? new Date(Date.now()+days*86400000) : null;
  await setDoc(doc(db,'bans', currentUserId), {
    banned:true, reason:banReason.value||'', until: until? until.toISOString():null, by:auth.currentUser?.uid||'(unknown)', at:serverTimestamp()
  }, { merge:true });
  await showUser(currentUserId);
  alert('정지 처리 완료');
};
uUnban.onclick = async ()=>{
  if(!currentUserId) return alert('대상 사용자를 먼저 검색하세요.');
  await setDoc(doc(db,'bans', currentUserId), { banned:false, reason:'', until:null, by:auth.currentUser?.uid||'(unknown)', at:serverTimestamp() }, { merge:true });
  await showUser(currentUserId);
  alert('정지 해제 완료');
};

/* ===== 관리자 ===== */
const admList=$('admin-list');
$('adm-add-nick').onclick = async ()=>{
  const nick=$('adm-nick').value.trim(); if(!nick) return alert('별명을 입력하세요.');
  const key=nick.toLowerCase(); const nSnap=await getDoc(doc(db,'nicknames', key));
  if(!nSnap.exists()) return alert('해당 별명이 없습니다.');
  await addAdmin(nSnap.data().uid, `nick:${key}`);
};
$('adm-add-uid').onclick = async ()=>{
  const uid=$('adm-uid').value.trim(); if(!uid) return alert('UID를 입력하세요.');
  await addAdmin(uid, 'uid');
};
async function addAdmin(uid, via){
  const me=auth.currentUser?.uid || '(unknown)';
  await setDoc(doc(db,'admins', uid), { at:serverTimestamp(), by:me, via }, { merge:true });
  await loadAdmins();
  $('adm-nick').value=''; $('adm-uid').value='';
}
async function loadAdmins(){
  admList.innerHTML='<div class="empty">불러오는 중…</div>';
  const snap=await getDocs(query(collection(db,'admins')));
  const items=await Promise.all(snap.docs.map(async d=>{
    const uid=d.id; let nick='(닉네임 없음)';
    try{ const u=await getDoc(doc(db,'users',uid)); if(u.exists()) nick=u.data()?.nickname||nick; }catch{}
    return { id:uid, nick, meta:d.data() };
  }));
  admList.innerHTML='';
  if(!items.length){ admList.innerHTML='<div class="empty">등록된 관리자가 없습니다.</div>'; return; }
  items.forEach(a=>{
    const el=document.createElement('div'); el.className='row';
    el.innerHTML=`<div>
      <div class="meta">UID: ${esc(a.id)} · 추가: ${fmt(a.meta?.at)}${a.meta?.by?` · by ${esc(a.meta.by)}`:''}</div>
      <div class="title">${esc(a.nick)}</div>
    </div>
    <div><button class="btn danger" data-del="${a.id}">삭제</button></div>`;
    el.querySelector(`[data-del="${a.id}"]`).onclick=async()=>{
      if(!confirm('이 사용자를 관리자에서 제거할까요?')) return;
      await deleteDoc(doc(db,'admins', a.id)).catch(console.error);
      el.remove();
    };
    admList.appendChild(el);
  });
}

/* ===== 공통 삭제 유틸 ===== */
function toPathArray(p){ return Array.isArray(p)? p: p.split('/'); }
async function deleteCollectionDeep(pathOrArr, pageSize=100, perDocCallback=null){
  const p=toPathArray(pathOrArr); let cursor=null;
  while(true){
    let qref=query(collection(db,...p), orderBy('createdAt','asc'), limit(pageSize));
    const snap=await getDocs(cursor? query(qref,startAfter(cursor)) : qref)
      .catch(async()=>{ let q2=query(collection(db,...p), orderBy('__name__','asc'), limit(pageSize));
        return await getDocs(cursor? query(q2,startAfter(cursor)) : q2); });
    if(snap.empty) break;
    const batch=writeBatch(db);
    for(const d of snap.docs){ if(typeof perDocCallback==='function'){ await perDocCallback(d.id); } batch.delete(d.ref); }
    await batch.commit();
    cursor=snap.docs[snap.docs.length-1];
  }
}
async function deleteSubcollectionDeep(pathArr, pageSize=200, perDocCb=null){
  return await deleteCollectionDeep(pathArr, pageSize, perDocCb);
}
async function deletePostDeep(postId){
  await deleteSubcollectionDeep(['communityPosts', postId, 'comments'], 100, async (cmtId)=>{
    await deleteSubcollectionDeep(['communityPosts', postId, 'comments', cmtId, 'replies'], 200);
  });
  await deleteSubcollectionDeep(['communityPosts', postId, 'likes'], 200);
  await deleteDoc(doc(db,'communityPosts',postId));
}

/* ===== 탭 스위치 (관리자 화면에서만) ===== */
[['tab-home','panel-home'],['tab-posts','panel-posts'],['tab-chat','panel-chat'],['tab-comments','panel-comments'],['tab-users','panel-users'],['tab-admin','panel-admin']]
  .forEach(([tid,pid])=>{
    const t=$(tid), p=$(pid); if(!t) return;
    t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(btn=>btn.classList.remove('active'));
      document.querySelectorAll('#admin-app section.card').forEach(sec=>sec.style.display='none');
      t.classList.add('active'); p.style.display='block';
    };
  });
</script>
</body>
</html>
