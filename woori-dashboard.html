<!doctype html>   
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>대시보드</title>
<link rel="icon" href="data:,">
<style>
:root{
  --bg:#0b1020;--panel:#121831;--ink:#e5e7eb;--muted:#9aa3b2;
  --accent:#7c3aed;--accent2:#8b5cf6;--danger:#ef4444;
  --ok:#10b981;--warn:#f59e0b;--bd:#1f2745;--radius:14px;--max:1120px;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0b1020,#0f1530);color:var(--ink);font:15px/1.6 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial}
a{color:inherit}
.wrap{max-width:var(--max);margin:24px auto;padding:0 16px}
.topbar{display:flex;gap:12px;justify-content:space-between;align-items:center;margin-bottom:14px}
.brand{display:flex;gap:10px;align-items:center}
.badge{padding:4px 10px;border:1px solid var(--bd);border-radius:999px;color:var(--muted);font-size:12px;background:#101734}
.pill{padding:4px 10px;border-radius:999px;border:1px solid var(--bd);background:#0e1530}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
@media (min-width:980px){.grid{grid-template-columns:1fr 320px}}
.panel{background:linear-gradient(180deg,#121831,#0f142d);border:1px solid var(--bd);border-radius:var(--radius);padding:14px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
.panel h2{margin:0 0 8px;font-size:16px}
.k,.hint{color:var(--muted);font-size:12px}
.row{display:flex;gap:10px;align-items:center}
.space{justify-content:space-between}
.btn{padding:8px 12px;border-radius:10px;background:#1a2142;border:1px solid var(--bd);color:var(--ink);cursor:pointer}
.btn.small{padding:6px 10px;font-size:13px}
.btn.primary{background:linear-gradient(180deg,var(--accent2),var(--accent));border-color:#6d28d9}
.btn.danger{background:#2b1117;border-color:#3a1a25;color:#fecaca}
.field{border:1px solid var(--bd);background:#0e1530;color:var(--ink);border-radius:10px}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
.stat{border:1px solid var(--bd);border-radius:12px;padding:10px;background:#0e1530;display:flex;justify-content:space-between;align-items:center}
.stat b{font-size:18px}
.list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
.task{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;border:1px dashed var(--bd);border-radius:12px;padding:12px;background:#0f1736}
.left{display:flex;flex-direction:column;gap:6px}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--bd);color:#9aa3b2;background:#0b1230}
.chip.warn{color:#fffbeb;border-color:#7c2d12;background:#3b1d0f}
.chip.stat-open{border-color:#334155;color:#cbd5e1}
.chip.stat-prog{border-color:#1d4ed8;color:#bfdbfe}
.chip.stat-done{border-color:#16a34a;color:#bbf7d0}
.right{display:flex;flex-direction:column;gap:4px;align-items:flex-end}
.tabs button{padding:8px 12px;border-radius:10px;border:1px solid var(--bd);background:#0b1230;color:#e5e7eb;cursor:pointer}
.tabs button[aria-pressed="true"]{background:#1a2142}

/* 메모 툴팁 */
.tip-wrap{position:relative;display:inline-flex;align-items:center}
.tip{cursor:help}
.tip-wrap .tip-box{
  position:absolute;left:0;bottom:calc(100% + 8px);
  min-width:240px;max-width:360px;padding:10px 12px;border-radius:10px;
  background:#0c1433;border:1px solid #253056;color:#cbd5e1;
  box-shadow:0 10px 24px rgba(0,0,0,.35);
  font-size:13px;line-height:1.5;white-space:pre-wrap;
  opacity:0;transform:translateY(6px);pointer-events:none;transition:.16s ease;z-index:30
}
.tip-wrap:hover .tip-box{opacity:1;transform:translateY(0);pointer-events:auto}
.tip-box .tip-title{display:flex;align-items:center;gap:6px;margin-bottom:6px;color:#9aa3b2;font-size:12px}

/* Toast */
#toasts{position:fixed;right:16px;bottom:16px;z-index:300;display:flex;flex-direction:column;gap:10px;pointer-events:none}
.toast{pointer-events:auto;min-width:260px;max-width:360px;border-radius:12px;padding:12px 14px;
  display:flex;gap:10px;align-items:center;color:#e5e7eb;opacity:0;transform:translateY(10px);
  animation:toast-in .25s ease-out forwards;box-shadow:0 10px 30px rgba(0,0,0,.35);border-left:5px solid;}
.toast .icon{font-size:18px;line-height:1.2}
.toast.info{background:#1a2142;border-left-color:#8b5cf6}
.toast.success{background:#0f2b1f;border-left-color:#10b981}
.toast.warn{background:#3b250f;border-left-color:#f59e0b}
.toast.error{background:#3a1313;border-left-color:#ef4444}
.toast .msg{flex:1;font-size:14px;line-height:1.4}
.toast .t-close{background:transparent;border:0;color:#9aa3b2;cursor:pointer;font-size:16px}
@keyframes toast-in{to{opacity:1;transform:translateY(0)}}

/* Mobile */
@media (max-width: 820px){
  .grid{grid-template-columns:1fr}
  .right{align-items:flex-start}
  .tip-wrap .tip-box{left:auto;right:0}
}

/* ── 수술 현황(작은 리스트) ── */
.s-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.s-item{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;
  border:1px dashed var(--bd);border-radius:10px;padding:8px;background:#0e1530}
.s-item b{font-weight:600}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M12 3l8 4.5v9L12 21 4 16.5v-9L12 3z" stroke="#8b5cf6" stroke-width="1.4"/></svg>
      <div>
        <div style="font-weight:700">대시보드</div>
        <div class="k">날짜별 실시간 업무 현황</div>
      </div>
    </div>
    <div class="row">
      <span id="clock" class="badge">--:--</span>
      <span id="me" class="badge">로그인 확인 중…</span>
      <button id="go-woori" class="btn">업무등록</button>
      <button id="go-posting" class="btn">게시판</button>
      <button id="go-chat" class="btn">채팅</button>
    </div>
  </div>

  <div class="grid">
    <section class="panel">
      <div class="row space">
        <h2>현황</h2>
        <div class="row" style="gap:6px">
          <button id="prev-day" class="btn small">←</button>
          <input id="day" type="date" class="field" style="width:auto;padding:6px 10px">
          <button id="next-day" class="btn small">→</button>
        </div>
        <div class="tabs">
          <button class="tab" data-state="all" aria-pressed="true">전체</button>
          <button class="tab" data-state="open">대기</button>
          <button class="tab" data-state="in_progress">진행중</button>
          <button class="tab" data-state="done">완료</button>
        </div>
      </div>
      <div id="list" class="list"></div>
    </section>

    <aside class="panel">
      <h2>요약</h2>
      <div class="stats">
        <div class="stat"><div>대기</div><b id="cnt-open">0</b></div>
        <div class="stat"><div>진행중</div><b id="cnt-prog">0</b></div>
        <div class="stat"><div>완료</div><b id="cnt-done">0</b></div>
      </div>
      <canvas id="statusChart" height="200" style="margin-top:16px"></canvas>

      <!-- 처리시간 요약 -->
      <div style="margin-top:14px">
        <div class="k">처리시간 (현재 필터 기준)</div>
        <div class="stats" style="grid-template-columns:repeat(2,1fr);gap:10px;margin-top:6px">
          <div class="stat"><div>평균</div><b id="avg-time">-</b></div>
          <div class="stat"><div>최장</div><b id="max-time">-</b></div>
        </div>
        <div id="max-time-desc" class="k" style="margin-top:6px">완료된 업무 기준으로 집계됩니다.</div>
      </div>

      <div style="margin-top:12px">
        <div class="k">필터</div>
        <div class="filters" style="margin-top:6px">
          <label class="pill"><input id="trans-only" type="checkbox"> 이송</label>
          <label class="pill"><input id="misc-only"  type="checkbox"> 기타</label>
          <label class="pill"><input id="sound-toggle" type="checkbox" checked> 사운드</label>
        </div>
      </div>

      <!-- 수술 현황 -->
      <div style="margin-top:18px;border-top:1px solid var(--bd);padding-top:14px">
        <div class="row space">
          <h2>수술 현황</h2>
          <span class="k">오늘(선택 날짜) 기준 · <span id="surg-updated">--:--</span></span>
        </div>
        <div class="stats">
          <div class="stat"><div>수술대기</div><b id="op-wait">0건</b></div>
          <div class="stat"><div>수술진행중</div><b id="op-prog">0건</b></div>
          <div class="stat"><div>완료</div><b id="op-done">0건</b></div>
        </div>
        <canvas id="surgeryChart" height="180" style="margin-top:12px"></canvas>

        <div class="k" style="margin-top:10px">최근 수술 5건</div>
        <div id="surg-list" class="s-list">
          <div class="k">불러오는 중…</div>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- Toast -->
<div id="toasts"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth,onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getFirestore,collection,query,where,orderBy,onSnapshot,Timestamp,updateDoc,deleteDoc,doc,getDoc, serverTimestamp } 
from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

/* ===== DOM/유틸 ===== */
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]||m));
const Z=n=>String(n).padStart(2,'0');
const toDate=ts=>ts?.toDate?.()||null;
const fmt=d=>`${d.getFullYear()}-${Z(d.getMonth()+1)}-${Z(d.getDate())} ${Z(d.getHours())}:${Z(d.getMinutes())}:${Z(d.getSeconds())}`;
function formatWhen(ts){try{const d=toDate(ts)||new Date();return`${d.getFullYear()}-${Z(d.getMonth()+1)}-${Z(d.getDate())} ${Z(d.getHours())}:${Z(d.getMinutes())}`;}catch{return'';}}
function fmtDuration(ms){ if(!Number.isFinite(ms)||ms<0) return '-'; const s=Math.floor(ms/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const ss=s%60; if(h>0) return `${h}시간 ${m}분`; if(m>0) return `${m}분 ${ss}초`; return `${ss}초`; }
function cleanTitle(text){ let t=String(text||''); return t.replace(/^[^▶]{1,30}\s*▶\s*/,'▶ '); }

const clock=$('#clock'),me=$('#me'),list=$('#list');
const cntOpen=$('#cnt-open'),cntProg=$('#cnt-prog'),cntDone=$('#cnt-done');
const transOnly=$('#trans-only'),miscOnly=$('#misc-only'),soundToggle=$('#sound-toggle');
$('#go-woori').onclick=()=>location.href='woori.html';
$('#go-posting').onclick=()=>location.href='posting.html';
$('#go-chat').onclick=()=>location.href='chat.html';
const dayInput=$('#day'),prevBtn=$('#prev-day'),nextBtn=$('#next-day');
function tick(){clock.textContent=fmt(new Date())}tick();setInterval(tick,1000);

/* 처리시간 DOM */
const avgTimeEl=document.getElementById('avg-time');
const maxTimeEl=document.getElementById('max-time');
const maxTimeDescEl=document.getElementById('max-time-desc');

/* 수술 DOM */
const opWaitEl=$('#op-wait'), opProgEl=$('#op-prog'), opDoneEl=$('#op-done');
const surgListEl=$('#surg-list'); const surgUpdatedEl=$('#surg-updated');

/* ===== Firebase ===== */
const firebaseConfig={apiKey:"AIzaSyACn_-2BLztKYmBKXtrKNtMsC-2Y238oug",authDomain:"woori-1ecf5.firebaseapp.com",
projectId:"woori-1ecf5",storageBucket:"woori-1ecf5.firebasestorage.app",messagingSenderId:"1073097361525",
appId:"1:1073097361525:web:3218ced6a040aaaf4d503c",databaseURL:"https://woori-1ecf5-default-rtdb.firebaseio.com"};
const app=initializeApp(firebaseConfig);const auth=getAuth(app);const db=getFirestore(app);

/* ===== 상태 ===== */
let cur=null,isAdmin=false,unsub=null,snapshotData=[];let prevSnapshot=new Map();
let unsubSurgery=null, surgeryData=[];
let prevSurgerySnapshot=null; // Map<id, doc>

/* ===== 날짜 관리 ===== */
const Z2=n=>String(n).padStart(2,'0');
const toYMD=d=>`${d.getFullYear()}-${Z2(d.getMonth()+1)}-${Z2(d.getDate())}`;
const parseYMD=ymd=>{const[y,m,dn]=(ymd||'').split('-').map(Number);const d=new Date(y,m-1,dn);d.setHours(0,0,0,0);return d;}
const getDateFromURL=()=>new URL(location.href).searchParams.get('date');
const setDateToURL=ymd=>{const u=new URL(location.href);u.searchParams.set('date',ymd);history.replaceState(null,'',u.toString());};
let selectedYMD=getDateFromURL()||toYMD(new Date());
dayInput.value=selectedYMD;
dayInput.addEventListener('change',()=>{selectedYMD=dayInput.value;setDateToURL(selectedYMD);subscribeByDate(selectedYMD,true);subscribeSurgeryByDate(selectedYMD,true);});
prevBtn.addEventListener('click',()=>{const d=parseYMD(selectedYMD);d.setDate(d.getDate()-1);selectedYMD=toYMD(d);dayInput.value=selectedYMD;setDateToURL(selectedYMD);subscribeByDate(selectedYMD,true);subscribeSurgeryByDate(selectedYMD,true);});
nextBtn.addEventListener('click',()=>{const d=parseYMD(selectedYMD);d.setDate(d.getDate()+1);selectedYMD=toYMD(d);dayInput.value=selectedYMD;setDateToURL(selectedYMD);subscribeByDate(selectedYMD,true);subscribeSurgeryByDate(selectedYMD,true);});

/* ===== 로그인 ===== */
onAuthStateChanged(auth,async user=>{cur=user||null;me.textContent=user?`${user.displayName||'사용자'}님`:'로그인이 필요합니다';
try{isAdmin=user?(await getDoc(doc(db,'admins',user.uid))).exists():false;}catch{}
subscribeByDate(selectedYMD,true);subscribeSurgeryByDate(selectedYMD,true);
});

/* ===== Toast + Beep ===== */
function showToast(message,type='info',ms){
  const wrap=$('#toasts');const el=document.createElement('div');
  el.className=`toast ${type}`;
  const icons={info:'💬',success:'✅',warn:'⚠️',error:'❌'};
  const colorTime={info:3500,success:3000,warn:4000,error:5000};
  ms = ms || colorTime[type] || 3500;
  el.innerHTML=`<div class="icon">${icons[type]||'🔔'}</div><div class="msg">${esc(message)}</div><button class="t-close">×</button>`;
  el.querySelector('.t-close').onclick=()=>remove();
  wrap.appendChild(el);
  const timer=setTimeout(()=>remove(),ms);
  function remove(){clearTimeout(timer);el.style.transition='opacity .3s, transform .3s';el.style.opacity='0';el.style.transform='translateY(6px)';setTimeout(()=>el.remove(),300);}
}
function playIMChime(kind='join', volume=0.35) {
  if (!soundToggle?.checked) return;
  const AC = window.AudioContext || window.webkitAudioContext;
  if (!AC) return;
  const ctx = new AC();
  const out = ctx.createGain(); out.gain.value = volume; out.connect(ctx.destination);
  const delay = ctx.createDelay(0.25); delay.delayTime.value = 0.11;
  const fb = ctx.createGain(); fb.gain.value = 0.18;
  delay.connect(fb); fb.connect(delay);
  delay.connect(out);
  function tone(freq, start, dur, type='sine', gainStart=1.0) {
    const osc = ctx.createOscillator(); const g = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, ctx.currentTime + start);
    g.gain.setValueAtTime(0.0001, ctx.currentTime + start);
    g.gain.exponentialRampToValueAtTime(gainStart, ctx.currentTime + start + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + start + dur);
    osc.connect(g); g.connect(delay); g.connect(out);
    osc.start(ctx.currentTime + start);
    osc.stop(ctx.currentTime + start + dur + 0.02);
  }
  if (kind === 'join') { tone(880,0.00,0.22,'sine',0.9); tone(1318,0.09,0.18,'triangle',0.75); }
  else if (kind === 'leave') { tone(660,0.00,0.20,'sine',0.85); tone(440,0.10,0.28,'triangle',0.7); }
  else { tone(988,0.00,0.14,'triangle',0.9); }
}

/* ===== Firestore 구독(업무) ===== */
function subscribeByDate(ymd,notify){
  try{unsub&&unsub();}catch{}
  const start=parseYMD(ymd);const end=new Date(start);end.setDate(end.getDate()+1);
  const qy=query(collection(db,'wardTasks'),
    where('createdAt','>=',Timestamp.fromDate(start)),
    where('createdAt','<',Timestamp.fromDate(end)),
    orderBy('createdAt','desc'));
  unsub=onSnapshot(qy,snap=>{
    const newData=snap.docs.map(d=>({id:d.id,...d.data()}));
    if(notify&&prevSnapshot.size){
      const newMap=new Map(newData.map(x=>[x.id,x]));
      if (newMap.size > prevSnapshot.size){ showToast('새 업무가 등록되었습니다.','success'); playIMChime('join'); }
      else if (newMap.size < prevSnapshot.size){ showToast('업무가 삭제되었습니다.','warn'); playIMChime('leave'); }
      else {
        for (const [id, oldDoc] of prevSnapshot.entries()){
          const curDoc = newMap.get(id);
          if (curDoc && (oldDoc.status||'open') !== (curDoc.status||'open')){
            const labels = { open:'대기', in_progress:'진행중', done:'완료' };
            showToast(`업무 상태가 '${labels[curDoc.status]||curDoc.status}'(으)로 변경되었습니다.`,'info');
            playIMChime('note');
            break;
          }
        }
      }
      prevSnapshot=newMap;
    }else prevSnapshot=new Map(newData.map(x=>[x.id,x]));
    snapshotData=newData;render();
  },err=>{list.innerHTML=`<div class="k">목록 오류: ${esc(err.message||err.code||'')}</div>`;});
}

/* ===== Firestore 구독(수술) + 알림 + 타임스탬프 기록 ===== */
function subscribeSurgeryByDate(ymd,notify){
  try{unsubSurgery && unsubSurgery();}catch{}
  surgListEl.innerHTML='<div class="k">불러오는 중…</div>';
  const start=parseYMD(ymd);const end=new Date(start);end.setDate(end.getDate()+1);

  const qy=query(collection(db,'surgeries'),
    where('createdAt','>=',Timestamp.fromDate(start)),
    where('createdAt','<',Timestamp.fromDate(end)),
    orderBy('createdAt','desc')
  );
  unsubSurgery = onSnapshot(qy, async (snap)=>{
    const arr = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    surgeryData = arr;
    // 알림/변화 감지
    const mapNow = new Map(arr.map(x=>[x.id,x]));
    if (notify && prevSurgerySnapshot){
      if (mapNow.size > prevSurgerySnapshot.size){ showToast('새 수술이 등록되었습니다.','success'); playIMChime('join'); }
      else if (mapNow.size < prevSurgerySnapshot.size){ showToast('수술이 삭제되었습니다.','warn'); playIMChime('leave'); }
      else {
        for (const [id, oldDoc] of prevSurgerySnapshot.entries()){
          const curDoc = mapNow.get(id);
          if (!curDoc) continue;
          const oldS = oldDoc.status || 'waiting';
          const newS = curDoc.status || 'waiting';
          if (oldS !== newS){
            await onSurgeryStatusChanged(id, oldDoc, curDoc);
            break;
          }
        }
      }
    }
    prevSurgerySnapshot = mapNow;

    renderSurgery();
  },err=>{
    opWaitEl.textContent='-'; opProgEl.textContent='-'; opDoneEl.textContent='-';
    surgListEl.innerHTML=`<div class="k">수술 목록 오류: ${esc(err.message||err.code||'')}</div>`;
  });
}

const SURG_LABEL = { waiting:'수술대기', operating:'수술진행중', done:'완료' };

async function onSurgeryStatusChanged(id, oldDoc, curDoc){
  showToast(`수술 상태가 '${SURG_LABEL[curDoc.status]||curDoc.status}'(으)로 변경되었습니다.`,'info');
  playIMChime('note');

  // 권한 있을 때 타임스탬프 기록(작성자 또는 관리자)
  try{
    if(!cur) return;
    const isOwner = curDoc?.createdBy?.uid && (curDoc.createdBy.uid === cur.uid);
    if (!(isOwner || isAdmin)) return;

    const patch = { updatedAt: serverTimestamp() };
    const hadStarted = !!(curDoc?.timestamps?.startedAt);
    const hadDone = !!(curDoc?.timestamps?.doneAt);

    if (curDoc.status === 'operating' && !hadStarted) patch['timestamps.startedAt'] = serverTimestamp();
    if (curDoc.status === 'done' && !hadDone)         patch['timestamps.doneAt']   = serverTimestamp();

    if (Object.keys(patch).length > 1){ // updatedAt 외에 뭔가 찍을 게 있을 때만
      await updateDoc(doc(db,'surgeries',id), patch);
    }
  }catch(e){
    // 기록 실패는 조용히 무시 (권한 없거나 네트워크 오류)
  }
}

/* ===== Chart.js (업무) ===== */
let statusChart=null;
function updateChart(open,prog,done){
  const ctx=document.getElementById('statusChart').getContext('2d');
  const data={labels:['대기','진행중','완료'],
    datasets:[{data:[open,prog,done],backgroundColor:['#334155','#2563eb','#16a34a'],borderColor:'#1f2937',borderWidth:1}]};
  const options={plugins:{legend:{labels:{color:'#e5e7eb'}},tooltip:{callbacks:{label:c=>`${c.label}: ${c.formattedValue}`}}}};
  if(statusChart){statusChart.data.datasets[0].data=[open,prog,done];statusChart.update();}
  else{statusChart=new Chart(ctx,{type:'doughnut',data,options});}
}

/* ===== Chart.js (수술 + 중앙요약) ===== */
let surgeryChart=null;
const doughnutCenterText = {
  id:'doughnutCenterText',
  afterDraw(chart,args,opts){
    const {ctx,chartArea:{width,height}}=chart;
    const total=opts.total||0, running=opts.running||0;
    const msg = total===0 ? '오늘 0건' : `오늘 ${total}건`;
    const sub = total>0 ? (running>0 ? `진행 ${running}건` : '모두 완료') : '';
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle='#e5e7eb';
    ctx.font='600 15px system-ui,-apple-system,Segoe UI,Inter';
    ctx.fillText(msg,width/2,height/2-7);
    ctx.font='12px system-ui,-apple-system,Segoe UI,Inter'; ctx.fillStyle='#9aa3b2';
    if(sub) ctx.fillText(sub,width/2,height/2+12);
    ctx.restore();
  }
};
function updateSurgeryChart(waiting,operating,done){
  const ctx=document.getElementById('surgeryChart').getContext('2d');
  const data={labels:['수술대기','수술진행중','완료'],
    datasets:[{data:[waiting,operating,done],
      backgroundColor:['#6b7280','#f59e0b','#10b981'],
      borderColor:'#1f2937',borderWidth:1}]};
  const options={plugins:{
      legend:{labels:{color:'#e5e7eb'}},
      tooltip:{callbacks:{label:c=>{
        const v=c.raw||0; const sum=(waiting+operating+done)||1;
        const pr=Math.round((v/sum)*100);
        return `${c.label}: ${v}건 (${pr}%)`;
      }}},
      doughnutCenterText:{ total:(waiting+operating+done), running:operating }
    }, cutout:'68%'};
  if(surgeryChart){
    surgeryChart.options.plugins.doughnutCenterText.total=waiting+operating+done;
    surgeryChart.options.plugins.doughnutCenterText.running=operating;
    surgeryChart.data.datasets[0].data=[waiting,operating,done];
    surgeryChart.update();
  }else{
    surgeryChart=new Chart(ctx,{type:'doughnut',data,options,plugins:[doughnutCenterText]});
  }
}

/* ===== 렌더(업무) ===== */
let stateFilter='all';
const tabs=$$('.tab');
tabs.forEach(btn=>btn.addEventListener('click',()=>{stateFilter=btn.dataset.state;tabs.forEach(b=>b.setAttribute('aria-pressed',String(b===btn)));render();}));
transOnly.addEventListener('change',()=>{if(transOnly.checked)miscOnly.checked=false;render();});
miscOnly.addEventListener('change',()=>{if(miscOnly.checked)transOnly.checked=false;render();});

function render(){
  const base=snapshotData.map(x=>({...x,status:x.status||'open'}));
  const cOpen=base.filter(x=>x.status==='open').length;
  const cProg=base.filter(x=>x.status==='in_progress').length;
  const cDone=base.filter(x=>x.status==='done').length;
  cntOpen.textContent=cOpen;cntProg.textContent=cProg;cntDone.textContent=cDone;
  updateChart(cOpen,cProg,cDone);

  let items=base.slice();
  if(stateFilter!=='all')items=items.filter(x=>x.status===stateFilter);
  if(transOnly.checked)items=items.filter(x=>x.category==='transport');
  if(miscOnly.checked)items=items.filter(x=>x.category==='misc');

  if(items.length===0){list.innerHTML='<div class="k">조건에 맞는 업무가 없습니다.</div>';return;}
  const frag=document.createDocumentFragment();
  items.forEach(d=>frag.appendChild(renderTask(d)));
  list.innerHTML='';list.appendChild(frag);

  // 처리시간 집계
  let sumMs=0,n=0,maxMs=-1,maxItem=null;
  for(const d of items){
    const ts=d.timestamps||{}; const done=toDate(ts.doneAt); if(!done) continue;
    const started=toDate(ts.startedAt)||toDate(d.createdAt); if(!started) continue;
    const ms=done-started; if(Number.isFinite(ms)&&ms>=0){sumMs+=ms;n++; if(ms>maxMs){maxMs=ms;maxItem=d;}}
  }
  if(n>0){
    avgTimeEl.textContent=fmtDuration(sumMs/n);
    maxTimeEl.textContent=fmtDuration(maxMs);
    const who=maxItem?.assignedTo?.name||'-'; const preview=(maxItem?.text||'').trim();
    maxTimeDescEl.textContent=`최장: ${who} · ${preview||'(제목 없음)'}`;
  }else{
    avgTimeEl.textContent='-'; maxTimeEl.textContent='-';
    maxTimeDescEl.textContent='완료된 업무가 없어서 집계할 수 없습니다.';
  }
}

/* ===== 렌더(업무 카드) ===== */
function renderTask(d){
  const el=document.createElement('div');el.className='task';
  const left=document.createElement('div');left.className='left';
  const chips=document.createElement('div');chips.className='chips';

  chips.appendChild(chip(d.category==='misc'?'기타':'이송업무'));
  chips.appendChild(chip(d.priority==='STAT'?'긴급':'보통',d.priority==='STAT'?'warn':''));  
  chips.appendChild(chip(d.status==='open'?'대기':d.status==='in_progress'?'진행중':'완료',
    d.status==='open'?'stat-open':d.status==='in_progress'?'stat-prog':'stat-done'));
  if(d.category!=='misc'){
    const mobK=d.mobility==='bed'?'이동침대':(d.mobility==='wheelchair'?'휠체어':'도보');
    chips.appendChild(chip(mobK));
  }

  if((d.note||'').trim()){
    const tipWrap=document.createElement('span'); tipWrap.className='tip-wrap';
    tipWrap.innerHTML=`
      <span class="chip tip">📝 메모</span>
      <div class="tip-box" role="tooltip" aria-label="메모 상세">
        <div class="tip-title">📝 메모 상세보기</div>
        ${esc(d.note||'')}
      </div>`;
    chips.appendChild(tipWrap);
  }

  const title=document.createElement('div');
  title.innerHTML=`<b>${esc(cleanTitle(d.text||''))}</b>`;
  left.appendChild(chips);left.appendChild(title);

  if((cur&&d.assignedTo?.uid===cur.uid)||isAdmin){
    const actions=document.createElement('div');actions.className='row';actions.style.cssText='gap:6px;flex-wrap:wrap;margin-top:6px';
    if(d.status==='open')actions.appendChild(btn('시작',()=>quickStatus(d.id,'in_progress')));
    if(d.status==='in_progress')actions.appendChild(btn('완료',()=>quickStatus(d.id,'done')));
    if(d.status==='done')actions.appendChild(btn('진행중',()=>quickStatus(d.id,'in_progress')));
    if(d.status!=='open')actions.appendChild(btn('대기',()=>quickStatus(d.id,'open')));
    const delB=document.createElement('button');delB.className='btn danger small';delB.textContent='삭제';delB.onclick=()=>delTask(d.id,d);
    actions.appendChild(delB);left.appendChild(actions);
  }

  const right=document.createElement('div');right.className='right';
  const lines=[];
  lines.push(`<div class="k">${esc(d.assignedTo?.name||'-')}</div>`);
  lines.push(`<div class="k">생성: ${formatWhen(d.createdAt)}</div>`);
  const ts=d.timestamps||{};
  if(ts.startedAt)  lines.push(`<div class="k">시작: ${formatWhen(ts.startedAt)}</div>`);
  if(ts.doneAt)     lines.push(`<div class="k">완료: ${formatWhen(ts.doneAt)}</div>`);
  if(ts.editedAt)   lines.push(`<div class="k">수정: ${formatWhen(ts.editedAt)}</div>`);
  if(ts.reopenedAt) lines.push(`<div class="k">대기: ${formatWhen(ts.reopenedAt)}</div>`);
  right.innerHTML=lines.join('');
  el.appendChild(left);el.appendChild(right);
  return el;
}
function chip(t,c=''){const s=document.createElement('span');s.className='chip'+(c?(' '+c):'');s.textContent=t;return s;}
function btn(l,f){const b=document.createElement('button');b.className='btn small';b.textContent=l;b.onclick=f;return b;}

/* ===== 상태 전환 타임스탬프 기록(업무) ===== */
async function quickStatus(id,nextStatus){
  try{
    const ref=doc(db,'wardTasks',id);
    const snap=await getDoc(ref);
    const curDoc = snap.exists()?snap.data():null;

    const patch = { status: nextStatus, updatedAt: serverTimestamp() };
    if (curDoc && (curDoc.status||'open') !== nextStatus){
      if (nextStatus==='in_progress')      patch['timestamps.startedAt']=serverTimestamp();
      else if (nextStatus==='done')        patch['timestamps.doneAt']=serverTimestamp();
      else if (nextStatus==='open')        patch['timestamps.reopenedAt']=serverTimestamp();
    }
    await updateDoc(ref, patch);
    const labels = { open:'대기', in_progress:'진행중', done:'완료' };
    showToast(`'${labels[nextStatus]||nextStatus}' 상태로 전환 중...`,'info',1800);
    playIMChime('note');
  }catch(e){
    showToast('권한 없음 또는 오류','error');
  }
}

/* ===== 렌더(수술) ===== */
function renderSurgery(){
  const base = surgeryData.map(x=>({ ...x, status: x.status || 'waiting' }));
  const C = {
    w: base.filter(x=>x.status==='waiting').length,
    p: base.filter(x=>x.status==='operating').length,
    d: base.filter(x=>x.status==='done').length
  };
  const pct = n => Math.round((n/(base.length||1))*100);

  opWaitEl.textContent = `${C.w}건 (${pct(C.w)}%)`;
  opProgEl.textContent = `${C.p}건 (${pct(C.p)}%)`;
  opDoneEl.textContent = `${C.d}건 (${pct(C.d)}%)`;

  // 업데이트 시각
  const now = new Date(); surgUpdatedEl.textContent = `${Z(now.getHours())}:${Z(now.getMinutes())}`;

  updateSurgeryChart(C.w,C.p,C.d);

  // 최근 5건 (PII 최소화)
  const items = base.slice(0,5);
  if(!items.length){ surgListEl.innerHTML = '<div class="k">표시할 수술이 없습니다.</div>'; return; }
  const frag = document.createDocumentFragment();
  items.forEach(x=>{
    const statusK = SURG_LABEL[x.status] || x.status;
    const chipClass = x.status==='waiting'?'stat-open':x.status==='operating'?'stat-prog':'stat-done';
    const title = `[${x.surgeryDept||'-'}] ${x.surgeryName||'-'}`;
    const el = document.createElement('div'); el.className='s-item';
    el.innerHTML = `
      <div>
        <div><b>${esc(title)}</b></div>
        <div class="k">${formatWhen(x.createdAt)}</div>
        <div class="k">#${esc(x.caseId||'-')}</div>
        ${x.note?`<div class="k">${esc(x.note)}</div>`:''}
      </div>
      <span class="chip ${chipClass}">${statusK}</span>`;
    frag.appendChild(el);
  });
  surgListEl.innerHTML=''; surgListEl.appendChild(frag);
}

/* ===== 삭제(업무) ===== */
async function delTask(id, data){
  if(!confirm('이 업무를 삭제할까요?')) return;
  try{
    await deleteDoc(doc(db,'wardTasks',id));
    showToast('업무가 삭제되었습니다.','warn');
    playIMChime('leave');
  }catch(e){
    showToast('삭제 실패','error');
  }
}
</script>
</body>
</html>
