<!doctype html> 
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="icon" href="data:,">
<title>ë¡œê·¸ì¸</title>
<meta http-equiv="Content-Security-Policy"
  content="
    default-src 'self';
    script-src 'self' https://www.gstatic.com https://www.googleapis.com 'unsafe-inline' 'unsafe-eval';
    style-src   'self' 'unsafe-inline';
    img-src     'self' data:;
    connect-src 'self' https://*.googleapis.com https://*.gstatic.com https://*.firebaseio.com https://*.firebaseapp.com;
    font-src    'self' data:;
    object-src  'none';
    base-uri    'none';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests">
<meta http-equiv="Referrer-Policy" content="no-referrer">
<meta http-equiv="Permissions-Policy"
  content="geolocation=(), camera=(), microphone=(), payment=(), usb=(), bluetooth=(), interest-cohort=()">
<style>
:root{--bg:#f6f7fb;--ink:#0f1724;--muted:#6b7280;--accent:#6d28d9}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Malgun Gothic,sans-serif;color:var(--ink)}
.wrap{max-width:520px;margin:40px auto;padding:16px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,.06);padding:18px}
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{flex:1;padding:10px 12px;border-radius:10px;text-align:center;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
.tab.active{background:var(--accent);color:#fff;border-color:transparent}
.row{display:flex;gap:8px;align-items:center}
.field{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;margin-top:10px}
.btn{padding:12px;border:0;border-radius:10px;background:var(--accent);color:#fff;font-weight:700;margin-top:12px;cursor:pointer}
.btn.small{padding:10px 12px;margin-top:0}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.muted{color:var(--muted);font-size:13px;margin-top:8px}
.topnav{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.link{padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;text-decoration:none;color:#111;background:#fff}
.notice{margin-top:12px;background:#fff7ed;border:1px solid #fdba74;color:#9a3412;border-radius:10px;padding:10px;font-size:13px}
@media (max-width:768px){ .wrap{padding:12px} .card{padding:12px} .field{font-size:16px} .btn{padding:10px 12px;font-size:14px} }
body{padding-bottom:env(safe-area-inset-bottom);-webkit-text-size-adjust:100%}
</style>
</head>
<body>
<div class="wrap">
  <div class="topnav">
    <strong>Woori</strong>
    <div style="display:flex;gap:8px"></div>
  </div>

  <div class="card">
    <div class="tabs" role="tablist">
      <button id="tab-login"  class="tab active" role="tab" aria-selected="true">ë¡œê·¸ì¸</button>
      <button id="tab-signup" class="tab" role="tab" aria-selected="false">íšŒì›ê°€ì…</button>
    </div>

    <!-- ë¡œê·¸ì¸ -->
    <div id="panel-login">
      <input id="login-nick" class="field" placeholder="ë³„ëª…(ë‹‰ë„¤ì„)" inputmode="latin" autocapitalize="none" autocomplete="username"/>
      <input id="login-pw"   class="field" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(6ì ì´ìƒ)" autocomplete="current-password" minlength="6"/>
      <button id="do-login"  class="btn">ë¡œê·¸ì¸</button>
      <div class="muted">ì´ ì„œë¹„ìŠ¤ëŠ” ì´ë©”ì¼ ì—†ì´ <b>ë³„ëª…+ë¹„ë°€ë²ˆí˜¸</b>ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.</div>
    </div>

    <!-- íšŒì›ê°€ì… -->
    <div id="panel-signup" style="display:none">
      <div class="row" style="gap:8px">
        <input id="sign-nick" class="field" placeholder="ë³„ëª…(ë‹‰ë„¤ì„)" inputmode="latin" autocapitalize="none" autocomplete="username"/>
        <button id="btn-check" class="btn small" type="button">ì¤‘ë³µ í™•ì¸</button>
      </div>
      <input id="sign-pw"  class="field" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(6ì ì´ìƒ)" autocomplete="new-password" minlength="6"/>
      <input id="sign-pw2" class="field" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="new-password" minlength="6"/>
      <label style="display:flex;gap:8px;align-items:flex-start;margin-top:10px">
        <input id="agree" type="checkbox" />
        <span>(í•„ìˆ˜) ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.<br/><span class="muted">ì„œë¹„ìŠ¤ ì œê³µ ë° ê³„ì • ê´€ë¦¬ ëª©ì ìœ¼ë¡œ ë‹‰ë„¤ì„ì„ ìˆ˜ì§‘Â·ì´ìš©í•©ë‹ˆë‹¤.</span></span>
      </label>
      <button id="do-signup" class="btn">íšŒì›ê°€ì…</button>
      <div class="muted">ê°€ì… í›„ ì¦‰ì‹œ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”.</div>
      <div class="notice">ğŸ”´ <b>ì£¼ì˜:</b> ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°/ë³µêµ¬ ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤. ê¼­ ê¸°ì–µí•´ ì£¼ì„¸ìš”.</div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged,
  createUserWithEmailAndPassword, signInWithEmailAndPassword,
  updateProfile, deleteUser, fetchSignInMethodsForEmail,
  setPersistence, browserSessionPersistence
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, getDocFromServer, setDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const cfg = {
  apiKey: "AIzaSyACn_-2BLztKYmBKXtrKNtMsC-2Y238oug",
  authDomain: "woori-1ecf5.firebaseapp.com",
  projectId: "woori-1ecf5",
  storageBucket: "woori-1ecf5.firebasestorage.app",
  messagingSenderId: "1073097361525",
  appId: "1:1073097361525:web:3218ced6a040aaaf4d503c",
  databaseURL: "https://woori-1ecf5-default-rtdb.firebaseio.com"
};
const app = initializeApp(cfg);
const auth = getAuth(app);
const db   = getFirestore(app);

await setPersistence(auth, browserSessionPersistence);

const $ = id => document.getElementById(id);
const tabLogin=$('tab-login'), tabSign=$('tab-signup');
const loginNick=$('login-nick'), loginPw=$('login-pw'), doLogin=$('do-login');
const signNick=$('sign-nick'),  signPw=$('sign-pw'),  signPw2=$('sign-pw2');
const btnCheck=$('btn-check'), agree=$('agree'), doSignup=$('do-signup');
const panelLogin=$('panel-login'), panelSign=$('panel-signup');

let nickOk=false, redirected=false, busy=false;
let lastCheckedNick="";

const normNick = n => n.trim().toLowerCase();
const validNick = n => /^[^\s]{2,20}$/.test(n.trim());
const makeEmailFromNick = n => `${normNick(n)}@nick.local`;

function safeAlert(msg){
  const s = String(msg||'').replace(/[<>&'"]/g, c=>({ '<':'&lt;','>':'&gt;','&':'&amp;',"'":'&#39;','"':'&quot;'}[c]));
  alert(s);
}
const err = e => safeAlert({
  "auth/email-already-in-use":"ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë³„ëª…ì…ë‹ˆë‹¤.",
  "auth/weak-password":"ë¹„ë°€ë²ˆí˜¸ê°€ 6ì ë¯¸ë§Œì…ë‹ˆë‹¤.",
  "auth/invalid-credential":"ë³„ëª… ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.",
  "permission-denied":"ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."
}[e?.code] || ('ì˜¤ë¥˜: ' + (e?.message || e?.code)));

async function ensureNickname(user, fallbackNick){
  const uRef = doc(db,'users',user.uid);
  const s = await getDoc(uRef);
  let nick = s.data()?.nickname?.trim();
  if(!nick){
    nick = user.displayName?.trim() || fallbackNick;
    await setDoc(uRef, { nickname:nick, createdAt: s.exists()? s.data().createdAt : serverTimestamp() }, { merge:true });
    try{ await updateProfile(user, { displayName:nick }); }catch{}
  }
  return nick;
}

/* ì´ë¯¸ ë¡œê·¸ì¸ ì¤‘ì´ë©´ ë¡œê·¸ì¸ í™”ë©´ ëŒ€ì‹  ë“±ë¡í˜ì´ì§€ë¡œ */
onAuthStateChanged(auth, (u)=>{ if(u && !redirected){ redirected=true; location.replace('woori.html'); } });

tabLogin.onclick=()=>{ tabLogin.classList.add('active'); tabSign.classList.remove('active'); panelLogin.style.display='block'; panelSign.style.display='none'; };
tabSign.onclick =()=>{ tabSign.classList.add('active'); tabLogin.classList.remove('active'); panelLogin.style.display='none'; panelSign.style.display='block'; };

signNick.addEventListener('input', ()=>{ nickOk=false; lastCheckedNick=""; });

btnCheck.onclick = async ()=>{
  const n = signNick.value.trim();
  if(!validNick(n)) return safeAlert('ë³„ëª…ì€ ê³µë°± ì—†ì´ 2~20ìë¡œ ì…ë ¥í•˜ì„¸ìš”.');
  setBusy(true);
  try{
    const key = normNick(n);
    const [nickDoc, methods] = await Promise.all([
      getDocFromServer(doc(db,'nicknames', key)),
      fetchSignInMethodsForEmail(auth, makeEmailFromNick(n))
    ]);
    const taken = nickDoc.exists() || methods.length>0;
    nickOk = !taken;
    lastCheckedNick = nickOk ? n : "";
    safeAlert(nickOk ? 'ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.' : 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.');
  }catch(e){ err(e); }
  finally{ setBusy(false); }
};

async function doLoginFlow(){
  const n = loginNick.value.trim(), p = loginPw.value.trim();
  if(!validNick(n)) return safeAlert('ë³„ëª…ì€ ê³µë°± ì—†ì´ 2~20ìë¡œ ì…ë ¥í•˜ì„¸ìš”.');
  if(p.length < 6)  return safeAlert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
  setBusy(true);
  try{
    const { user } = await signInWithEmailAndPassword(auth, makeEmailFromNick(n), p);
    await ensureNickname(user, n);
    redirected = true; location.replace('woori.html');
  }catch(e){ err(e); }
  finally{ setBusy(false); }
}

async function doSignupFlow(){
  const n  = signNick.value.trim();
  const p1 = signPw.value.trim();
  const p2 = signPw2.value.trim();

  if(!validNick(n))  return safeAlert('ë³„ëª…ì€ ê³µë°± ì—†ì´ 2~20ìë¡œ ì…ë ¥í•˜ì„¸ìš”.');
  if(p1.length < 6)  return safeAlert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
  if(p1 !== p2)      return safeAlert('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  if(!agree.checked) return safeAlert('ê°œì¸ì •ë³´ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.');

  if(!nickOk || normNick(n) !== normNick(lastCheckedNick)){
    return safeAlert('ë³„ëª…ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.');
  }

  setBusy(true);
  let createdUser = null;
  try{
    const key = normNick(n);
    const [nickDoc, methods] = await Promise.all([
      getDocFromServer(doc(db,'nicknames', key)),
      fetchSignInMethodsForEmail(auth, makeEmailFromNick(n))
    ]);
    if (nickDoc.exists() || methods.length>0) {
      nickOk = false; lastCheckedNick="";
      throw { code:'auth/email-already-in-use', message:'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë³„ëª…ì…ë‹ˆë‹¤.' };
    }

    const email = makeEmailFromNick(n);
    const { user } = await createUserWithEmailAndPassword(auth, email, p1);
    createdUser = user;

    try{
      await setDoc(doc(db,'nicknames', key), { uid:user.uid, at:serverTimestamp() });
    }catch(e){
      try{ await deleteUser(user); }catch{}
      throw { code:'auth/email-already-in-use', message:'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë³„ëª…ì…ë‹ˆë‹¤.' };
    }

    try{ await updateProfile(user, { displayName:n }); }catch{}
    await setDoc(doc(db,'users', user.uid), { nickname:n, createdAt:serverTimestamp() }, { merge:true });

    safeAlert('ê°€ì… ì™„ë£Œ! ê³¼ì—… ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
    redirected = true;
    /* âœ… ë³€ê²½ë¶€ë¶„: íšŒì›ê°€ì… ì™„ë£Œ í›„ wooril.html ë¡œ ì´ë™ */
    location.replace('wooril.html');
  }catch(e){
    if(createdUser && e?.code!=='auth/email-already-in-use'){
      try{ await deleteUser(createdUser); }catch{}
    }
    err(e);
  }finally{
    setBusy(false);
  }
}

function setBusy(state){
  busy = state;
  [doLogin, btnCheck, doSignup].forEach(b => b && (b.disabled = state));
}

doLogin.onclick  = doLoginFlow;
doSignup.onclick = doSignupFlow;
loginPw.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin.click(); });
loginNick.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin.click(); });
signPw2.addEventListener('keydown', e=>{ if(e.key==='Enter') doSignup.click(); });
</script>
</body>
</html>
