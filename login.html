<!doctype html> 
<html lang="ko">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ë¡œê·¸ì¸ â€¢ Freetalk</title>
<style>
:root{--bg:#f6f7fb;--ink:#0f1724;--muted:#6b7280;--accent:#6d28d9}
*{box-sizing:border-box}body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Malgun Gothic,sans-serif;color:var(--ink)}
.wrap{max-width:520px;margin:40px auto;padding:16px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,.06);padding:18px}
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{flex:1;padding:10px 12px;border-radius:10px;text-align:center;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
.tab.active{background:var(--accent);color:#fff;border-color:transparent}
.row{display:flex;gap:8px;align-items:center}
.field{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;margin-top:10px}
.btn{padding:12px;border:0;border-radius:10px;background:var(--accent);color:#fff;font-weight:700;margin-top:12px;cursor:pointer}
.btn.small{padding:10px 12px;margin-top:0}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.muted{color:var(--muted);font-size:13px;margin-top:8px}
.topnav{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.link{padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;text-decoration:none;color:#111;background:#fff}
.notice{margin-top:12px;background:#fff7ed;border:1px solid #fdba74;color:#9a3412;border-radius:10px;padding:10px;font-size:13px}
/* Mobile */
@media (max-width: 768px){
  .wrap{ padding:12px; }
  .card{ padding:12px; }
  .field{ width:100%; font-size:16px; }
  .btn{ padding:10px 12px; font-size:14px; }
}
body{ padding-bottom:env(safe-area-inset-bottom); -webkit-text-size-adjust:100%; }
</style>
</head>
<body>
<div class="wrap">
  <div class="topnav">
    <strong>Freetalk</strong>
    <div style="display:flex;gap:8px">
      <a class="link" href="index.html">ë©”ì¸</a>
      <a class="link" href="community.html">ì»¤ë®¤ë‹ˆí‹°</a>
    </div>
  </div>

  <div class="card">
    <div class="tabs" role="tablist">
      <button id="tab-login"  class="tab active" role="tab" aria-selected="true">ë¡œê·¸ì¸</button>
      <button id="tab-signup" class="tab" role="tab" aria-selected="false">íšŒì›ê°€ì…</button>
    </div>

    <!-- ë¡œê·¸ì¸ -->
    <div id="panel-login">
      <input id="login-nick" class="field" placeholder="ë³„ëª…(ë‹‰ë„¤ì„)" autocomplete="username"/>
      <input id="login-pw"   class="field" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(6ì ì´ìƒ)" autocomplete="current-password"/>
      <button id="do-login"  class="btn">ë¡œê·¸ì¸</button>
      <div class="muted">ì´ ì„œë¹„ìŠ¤ëŠ” ì´ë©”ì¼ ì—†ì´ <b>ë³„ëª…+ë¹„ë°€ë²ˆí˜¸</b>ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.</div>
    </div>

    <!-- íšŒì›ê°€ì… -->
    <div id="panel-signup" style="display:none">
      <div class="row" style="gap:8px">
        <input id="sign-nick" class="field" placeholder="ë³„ëª…(ë‹‰ë„¤ì„)" autocomplete="username"/>
        <button id="btn-check" class="btn small" type="button">ì¤‘ë³µ í™•ì¸</button>
      </div>
      <input id="sign-pw"  class="field" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(6ì ì´ìƒ)" autocomplete="new-password"/>
      <input id="sign-pw2" class="field" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="new-password"/>
      <label style="display:flex;gap:8px;align-items:flex-start;margin-top:10px">
        <input id="agree" type="checkbox" />
        <span>(í•„ìˆ˜) ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.<br/><span class="muted">ì„œë¹„ìŠ¤ ì œê³µ ë° ê³„ì • ê´€ë¦¬ ëª©ì ìœ¼ë¡œ ë‹‰ë„¤ì„ì„ ìˆ˜ì§‘Â·ì´ìš©í•©ë‹ˆë‹¤.</span></span>
      </label>
      <button id="do-signup" class="btn">íšŒì›ê°€ì…</button>
      <div class="muted">ê°€ì… í›„ ì¦‰ì‹œ ì»¤ë®¤ë‹ˆí‹°/ì±„íŒ…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.</div>
      <div class="notice">ğŸ”´ <b>ì£¼ì˜:</b> ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°/ë³µêµ¬ ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤. ê¼­ ê¸°ì–µí•´ ì£¼ì„¸ìš”.</div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, deleteUser } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const cfg = {
  apiKey: "AIzaSyACn_-2BLztKYmBKXtrKNtMsC-2Y238oug",
  authDomain: "woori-1ecf5.firebaseapp.com",
  projectId: "woori-1ecf5",
  storageBucket: "woori-1ecf5.appspot.com",   // â† ìˆ˜ì •: .firebasestorage.app âŒ
  messagingSenderId: "1073097361525",
  appId: "1:1073097361525:web:3218ced6a040aaaf4d503c",
  databaseURL: "https://woori-1ecf5-default-rtdb.firebaseio.com" // âœ… ì •í™•íˆ ì½˜ì†” URLê³¼ ë™ì¼
};

const app=initializeApp(cfg); const auth=getAuth(app); const db=getFirestore(app);

const $=id=>document.getElementById(id);
const tabLogin=$('tab-login'), tabSign=$('tab-signup');
const loginNick=$('login-nick'), loginPw=$('login-pw'), doLogin=$('do-login');
const signNick=$('sign-nick'),  signPw=$('sign-pw'),  signPw2=$('sign-pw2'), btnCheck=$('btn-check'), agree=$('agree'), doSignup=$('do-signup');
const panelLogin=$('panel-login'), panelSign=$('panel-signup');

let nickOk=false, redirected=false, busy=false;

const err = e=>alert( {
  "auth/email-already-in-use":"ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë³„ëª…ì…ë‹ˆë‹¤.",
  "auth/weak-password":"ë¹„ë°€ë²ˆí˜¸ê°€ 6ì ë¯¸ë§Œì…ë‹ˆë‹¤.",
  "auth/invalid-credential":"ë³„ëª… ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.",
  "permission-denied":"ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."
}[e.code] || ('ì˜¤ë¥˜: '+(e.message||e.code)));

const normNick = n=>n.trim().toLowerCase();
const validNick = n=>/^[^\s]{2,20}$/.test(n.trim()); // ê³µë°± ì—†ëŠ” 2~20ì
const makeEmailFromNick = n=>`${normNick(n)}@nick.local`;

/** ìµœì´ˆ ë¡œê·¸ì¸/ê°€ì… ì§í›„ users.nickname & displayName ë³´ì¥ */
async function ensureNickname(user, fallbackNick){
  const uRef = doc(db,'users',user.uid);
  const s = await getDoc(uRef);
  let nick = s.data()?.nickname?.trim();
  if(!nick){
    nick = user.displayName?.trim() || fallbackNick;
    if(!validNick(nick)) nick = fallbackNick; // ë°©ì–´
    await setDoc(uRef,{ nickname:nick, createdAt: s.exists()? s.data().createdAt : serverTimestamp() },{ merge:true });
    try{ await updateProfile(user,{ displayName:nick }); }catch{}
  }
  return nick;
}

/** (ë¡œê·¸ì¸ í›„ ë°±í•„) nicknames/{nickLower} ì—†ìœ¼ë©´ ì„ ì  ì‹œë„ */
async function claimNicknameIfMissing(uid, nick){
  const key = normNick(nick);
  try{
    const ref = doc(db,'nicknames', key);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      // ê·œì¹™: create only if id==nickLower && uid==auth.uid && !exists
      await setDoc(ref, { uid }, { merge:false });
    }
  }catch(e){
    // ì´ë¯¸ ì¡´ì¬/ê¶Œí•œì—†ìŒ ë“±ì€ ì¡°ìš©íˆ ë¬´ì‹œ(ë¡œê·¸ì¸ì—” ì˜í–¥ ì—†ìŒ)
  }
}

/** UI helpers */
function setBusy(state){
  busy = state;
  [doLogin, btnCheck, doSignup].forEach(b=>{ if(b) b.disabled=state; });
}

tabLogin.onclick=()=>{ tabLogin.classList.add('active'); tabSign.classList.remove('active'); panelLogin.style.display='block'; panelSign.style.display='none'; };
tabSign.onclick =()=>{ tabSign.classList.add('active'); tabLogin.classList.remove('active'); panelLogin.style.display='none'; panelSign.style.display='block'; };

/** ë¡œê·¸ì¸ ìƒíƒœë©´ ë°”ë¡œ ì´ë™ */
onAuthStateChanged(auth,(u)=>{ if(u && !redirected){ redirected=true; location.replace('chat.html'); } });

/** ë‹‰ ì…ë ¥ ë°”ë€Œë©´ ì¤‘ë³µí™•ì¸ ì´ˆê¸°í™” */
signNick.addEventListener('input', ()=>{ nickOk=false; });

btnCheck.onclick = async ()=>{
  const n = signNick.value.trim();
  if(!validNick(n)) return alert('ë³„ëª…ì€ ê³µë°± ì—†ì´ 2~20ìë¡œ ì…ë ¥í•˜ì„¸ìš”.');
  setBusy(true);
  try{
    const s = await getDoc(doc(db,'nicknames',normNick(n)));
    nickOk = !s.exists();
    alert(nickOk?'ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.':'ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.');
  }catch(e){ err(e); }
  finally{ setBusy(false); }
};

async function doLoginFlow(){
  const n=loginNick.value.trim(), p=loginPw.value.trim();
  if(!validNick(n)) return alert('ë³„ëª…ì€ ê³µë°± ì—†ì´ 2~20ìë¡œ ì…ë ¥í•˜ì„¸ìš”.');
  if(p.length<6)    return alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
  setBusy(true);
  try{
    const { user } = await signInWithEmailAndPassword(auth, makeEmailFromNick(n), p);
    const fixedNick = await ensureNickname(user, n);
    await claimNicknameIfMissing(user.uid, fixedNick);
    redirected=true; location.replace('chat.html');
  }catch(e){ err(e); }
  finally{ setBusy(false); }
}

async function doSignupFlow(){
  const n=signNick.value.trim(), p1=signPw.value.trim(), p2=signPw2.value.trim();
  if(!validNick(n)) return alert('ë³„ëª…ì€ ê³µë°± ì—†ì´ 2~20ìë¡œ ì…ë ¥í•˜ì„¸ìš”.');
  if(p1.length<6)  return alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
  if(p1!==p2)      return alert('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  if(!agree.checked) return alert('ê°œì¸ì •ë³´ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
  if(!nickOk) return alert('ë³„ëª… ì¤‘ë³µ í™•ì¸ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.');

  setBusy(true);
  try{
    const email = makeEmailFromNick(n);
    const { user } = await createUserWithEmailAndPassword(auth,email,p1);

    // ë‹‰ë„¤ì„ ì„ ì  (ê·œì¹™ìƒ createë§Œ í—ˆìš© â†’ ì´ë¯¸ ìˆìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ)
    try{
      await setDoc(doc(db,'nicknames',normNick(n)),{ uid:user.uid, at:serverTimestamp() });
    }catch(e){
      try{ await deleteUser(user); }catch{}
      throw { code:'auth/email-already-in-use', message:'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë³„ëª…ì…ë‹ˆë‹¤.' };
    }

    try{ await updateProfile(user,{ displayName:n }); }catch{}
    await setDoc(doc(db,'users',user.uid),{ nickname:n, createdAt:serverTimestamp() },{ merge:true });

    redirected=true; alert('ê°€ì… ì™„ë£Œ! ì±„íŒ…ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.'); location.replace('chat.html');
  }catch(e){ err(e); }
  finally{ setBusy(false); }
}

/** ë²„íŠ¼/Enter í•¸ë“¤ë§ */
doLogin.onclick = doLoginFlow;
doSignup.onclick = doSignupFlow;
loginPw.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin.click(); });
loginNick.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin.click(); });
signPw2.addEventListener('keydown', e=>{ if(e.key==='Enter') doSignup.click(); });

</script>
</body>
</html>
